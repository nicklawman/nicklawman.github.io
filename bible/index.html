<!doctype html>
<html lang="zh-Hant">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <link rel="icon" type="image/x-icon" href="favicon.ico" />
        <link rel="manifest" href="manifest.webmanifest" />
        <meta name="theme-color" content="#0d6efd" />
        <title>è–ç¶“-åº‡å“©äº</title>
        <style>
            :root {
                --bg: #0b0e12;
                --fg: #e8e8e8;
                --muted: #aab2bb;
                --acc: #0d6efd;
                --card: #141a22;
                --line: #2a3947;
                --btn-bg: #1e2a36;
                --btn-line: #3a4c60;
                --btn-fg: #ffffff;
                --fs: 1.8rem;

                /* summary (dark) */
                --doc-bg: #0b0e12;
                --doc-paper: #141a22;
                --doc-ink: #e8e8e8;
                --doc-muted: #aab2bb;
                --doc-line: #2a3947;
                --doc-accent: #7aa2ff;
                --summary-header-bg-dark: #3a3f44; /* softer gray */
            }
            :root[data-theme="light"] {
                --bg: #ffffff;
                --fg: #111827;
                --muted: #6b7280;
                --acc: #0d6efd;
                --card: #f7fafc;
                --line: #e5e7eb;
                --btn-bg: #ffffff;
                --btn-line: #d1d5db;
                --btn-fg: #111827;

                /* summary (light) */
                --doc-bg: #f7f7f9;
                --doc-paper: #ffffff;
                --doc-ink: #1f2937;
                --doc-muted: #6b7280;
                --doc-line: #e5e7eb;
                --doc-accent: #4f46e5;
                --summary-header-bg-dark: #e2e8f0; /* light gray */
            }

            html,
            body {
                height: 100%;
                margin: 0;
                background: var(--bg);
                color: var(--fg);
                font-family:
                    system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    Helvetica,
                    Arial;
            }
            body {
                font-size: var(--fs);
            }

            /* ===== Top line ===== */
            .topline {
                position: sticky;
                top: 0;
                z-index: 20;
                background: var(--card);
                border-bottom: 1px solid var(--line);
                padding: 0.6rem 0.9rem;
            }
            /* desktop: title (cross + name) at left, then 50px gap, then controls block */
            .toprow {
                display: flex;
                align-items: flex-start;
                gap: 50px;
                margin-left: 0.5rem;
            }
            /* mobile: stack title row above controls rows */
            body.mobile .toprow {
                flex-direction: column;
                gap: 0.6rem;
            }

            .titleWrap {
                display: flex;
                align-items: center;
                gap: 0.55rem;
                flex: 0 0 auto;
            }
            .book-title {
                font-weight: 800;
                font-size: 1.35em;
                letter-spacing: 0.02em;
                cursor: pointer;
            }

            /* Cross (desktop, now on the LEFT of book name) */
            .menu-btn {
                width: 44px;
                height: 44px;
                border-radius: 12px;
                display: grid;
                place-items: center;
                background: linear-gradient(180deg, #ffa42e, #f37f0a);
                color: #fff;
                font-weight: 900;
                font-size: 22px;
                border: 1px solid rgba(0, 0, 0, 0.15);
                box-shadow:
                    0 10px 22px rgba(0, 0, 0, 0.28),
                    inset 0 2px 1px rgba(255, 255, 255, 0.4);
                transition:
                    transform 0.08s ease,
                    box-shadow 0.08s ease;
                cursor: pointer;
                user-select: none;
            }
            .menu-btn:active {
                transform: translateY(1px) scale(0.98);
                box-shadow:
                    0 8px 16px rgba(0, 0, 0, 0.24),
                    inset 0 1px 0 rgba(255, 255, 255, 0.35);
            }

            /* Floating FAB (mobile only) */
            .menu-fab {
                position: fixed;
                right: 16px;
                top: 12px;
                z-index: 32;
                width: 56px;
                height: 56px;
                border-radius: 16px;
                display: none;
                place-items: center;
                background: linear-gradient(180deg, #ffa42e, #f37f0a);
                color: #fff;
                font-size: 28px;
                font-weight: 900;
                box-shadow:
                    0 14px 28px rgba(0, 0, 0, 0.35),
                    inset 0 2px 1px rgba(255, 255, 255, 0.4);
                border: 1px solid rgba(0, 0, 0, 0.15);
                transition:
                    transform 0.08s ease,
                    box-shadow 0.08s ease;
                user-select: none;
            }
            .menu-fab:active {
                transform: translateY(1px) scale(0.98);
                box-shadow:
                    0 10px 20px rgba(0, 0, 0, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.35);
            }
            .menu-fab::before {
                content: "+";
                transform: translateY(-1px);
            }

            .controls {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-start;
            }
            .chapters {
                display: flex;
                flex-wrap: wrap;
                gap: 0.35rem;
                padding-right: 0;
            }
            /* keep space so mobile numbers donâ€™t hide under FAB */
            body.mobile .chapters {
                padding-right: 90px;
            }

            .chapters button {
                background: var(--btn-bg);
                border: 1px solid var(--btn-line);
                color: var(--btn-fg);
                padding: 0.28rem 0.5rem;
                border-radius: 0.6rem;
                cursor: pointer;
                font-size: 0.95rem;
                flex: 0 0 auto;
            }
            .chapters button.active {
                background: var(--acc);
                border-color: var(--acc);
                color: #fff;
            }

            .navrow {
                display: flex;
                gap: 0.6rem;
            }
            .pill {
                background: var(--btn-bg);
                border: 1px solid var(--btn-line);
                color: var(--btn-fg);
                border-radius: 0.6rem;
                padding: 0.32rem 0.7rem;
                cursor: pointer;
                font-size: 1rem;
                user-select: none;
            }
            .navbtn {
                font-weight: 800;
            }

            /* ===== Main content ===== */
            .content {
                padding: 0 1rem 1.2rem;
            }
            .verses {
                background: var(--card);
                border: 1px solid var(--line);
                border-radius: 0.6rem;
                padding: 1rem;
                line-height: 1.8;
                max-width: 80ch;
                touch-action: pan-y;
                scroll-margin-top: 3.5rem;
            }
            .verse {
                margin: 0.12rem 0;
            }
            .vno {
                color: var(--muted);
                font-size: 0.9rem;
                margin-right: 0.35rem;
            }

            /* ===== Drawer ===== */
            .drawer-backdrop {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.35);
                backdrop-filter: blur(2px);
                opacity: 0;
                pointer-events: none;
                transition: 0.2s opacity;
                z-index: 30;
            }
            .drawer {
                position: fixed;
                top: 0;
                bottom: 0;
                width: min(92vw, 360px);
                background: var(--card);
                border-right: 1px solid var(--line);
                transform: translateX(-100%);
                transition: 0.25s transform;
                z-index: 31;
                overflow: auto;
            }
            body.drawer-open .drawer {
                transform: translateX(0);
            }
            body.drawer-open .drawer-backdrop {
                opacity: 1;
                pointer-events: auto;
            }

            .group-title {
                padding: 0.75rem 0.9rem 0.25rem;
                font-weight: 800;
            }
            .sub-title {
                padding: 0.35rem 0.9rem;
                font-weight: 700;
                color: var(--muted);
                font-size: 0.95rem;
            }
            .book-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 0.5rem;
                padding: 0.45rem 0.75rem;
                cursor: pointer;
                border-top: 1px solid var(--line);
            }
            .book-left {
                display: flex;
                align-items: center;
                gap: 0.55rem;
            }
            .book-name {
                color: var(--fg);
                font-weight: 600;
            }
            .arrow {
                transition: 0.2s transform;
                color: var(--fg);
            }
            .book-item.open .arrow {
                transform: rotate(90deg);
            }
            .chap-list {
                display: none;
                padding: 0.5rem 0.9rem;
                gap: 0.35rem;
                flex-wrap: wrap;
            }
            .book-item.open + .chap-list {
                display: flex;
            }

            .drawer-footer {
                position: sticky;
                bottom: 0;
                background: var(--card);
                border-top: 1px solid var(--line);
                padding: 0.7rem 0.8rem;
                display: flex;
                gap: 0.5rem;
                flex-wrap: wrap;
            }

            /* ===== Summary .doc (theme-aware) ===== */
            .doc {
                max-width: 820px;
                margin: clamp(16px, 4vw, 48px) auto;
                padding: clamp(16px, 4vw, 36px);
                background: var(--doc-paper);
                color: var(--doc-ink);
                border: 1px solid var(--doc-line);
                border-radius: 14px;
                box-shadow: 0 8px 24px rgba(31, 41, 55, 0.06);
            }
            .doc h1,
            .doc h2 {
                line-height: 1.25;
                margin: 1.2em 0 0.5em;
                font-weight: 750;
                letter-spacing: 0.2px;
            }
            .doc h1 {
                font-size: clamp(28px, 4.2vw, 36px);
                padding-bottom: 0.3em;
                border-bottom: 2px solid var(--doc-line);
            }
            .doc h2 {
                font-size: clamp(20px, 3.4vw, 26px);
                margin-top: 2rem;
                scroll-margin-top: 72px;
            }
            .doc p {
                margin: 0.7em 0 1em;
            }
            .doc b {
                font-weight: 700;
            }
            .doc ul {
                padding-left: 1.2rem;
                margin: 0.5rem 0 1rem;
            }
            .doc li {
                margin: 0.25rem 0;
            }

            .md-grid {
                display: table;
                width: 100%;
                border: 1px solid var(--doc-line);
                border-radius: 10px;
                border-collapse: collapse;
                margin: 1rem 0 1.5rem;
                overflow: hidden;
            }
            .md-grid-row {
                display: table-row;
            }
            .md-grid-header {
                background: var(--summary-header-bg-dark);
                font-weight: 700;
            }
            .md-grid-cell {
                display: table-cell;
                padding: 0.75rem 0.9rem;
                border-bottom: 1px solid var(--doc-line);
                border-right: 1px solid
                    color-mix(in srgb, var(--doc-line) 60%, #fff);
                vertical-align: top;
                text-align: left;
                overflow-wrap: anywhere;
            }
            .md-grid-cell:last-child {
                border-right: none;
            }
            .md-grid-row:nth-child(odd):not(.md-grid-header) {
                background: color-mix(
                    in srgb,
                    var(--doc-paper) 92%,
                    var(--doc-line) 8%
                );
            }
            @media (max-width: 560px) {
                .md-grid {
                    display: block;
                    overflow-x: auto;
                    -webkit-overflow-scrolling: touch;
                }
                .md-grid-row {
                    display: table;
                    width: 100%;
                    min-width: 560px;
                    table-layout: fixed;
                }
            }

            .hidden {
                display: none !important;
            }

            /* Which cross to show? */
            .menu-btn {
                display: initial;
            }
            .menu-fab {
                display: none;
            }
            body.mobile .menu-btn {
                display: none;
            } /* hide inline cross on mobile */
            body.mobile .menu-fab {
                display: grid;
            } /* show floating FAB on mobile */

            /* è®“æ‘˜è¦å€ä¹Ÿä¿æœ‰å‚ç›´æ²å‹•æ‰‹å‹¢ï¼ˆèˆ‡ verses ä¸€è‡´ï¼‰ */
            #summaryPane {
                touch-action: pan-y;
            }
        </style>
    </head>
    <body>
        <!-- Top line -->
        <div class="topline">
            <div class="toprow">
                <!-- Desktop: cross on LEFT of book name; Mobile: this whole row becomes the top row alone -->
                <div class="titleWrap">
                    <button id="menuBtnInline" class="menu-btn" title="é¸å–®">
                        +
                    </button>
                    <span id="bookTitle" class="book-title">â€”</span>
                </div>

                <!-- Controls: on mobile this is the second row; on desktop it's to the right with 50px gap -->
                <div class="controls">
                    <div id="chapterArea" class="chapters"></div>
                    <div class="navrow">
                        <button id="prevBookBtn" class="pill navbtn">Â«Â«</button>
                        <button id="prevBtn" class="pill navbtn">Â«</button>
                        <button id="nextBtn" class="pill navbtn">Â»</button>
                        <button id="nextBookBtn" class="pill navbtn">Â»Â»</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile floating cross -->
        <button id="menuFab" class="menu-fab" title="é¸å–®"></button>

        <!-- Drawer -->
        <div class="drawer-backdrop" id="backdrop"></div>
        <aside class="drawer" id="drawer">
            <div id="drawerContent"><!-- built by JS --></div>
            <div class="drawer-footer">
                <button id="fsDec" class="pill" title="å­—é«”è®Šå°">Aâˆ’</button>
                <button id="fsInc" class="pill" title="å­—é«”è®Šå¤§">A+</button>
                <button id="themeBtn" class="pill" title="åˆ‡æ›ä¸»é¡Œ">
                    ğŸŒ/ğŸŒš
                </button>
                <button id="churchBtn" class="pill" title="å¾ŒåŸ”æ•™æœƒ">
                    â›ª å¾ŒåŸ”æ•™æœƒ
                </button>
            </div>
        </aside>

        <div class="content">
            <main>
                <div id="reader" class="verses"></div>
                <div id="summaryPane" class="hidden"></div>
                <div
                    id="aboutChurch"
                    class="verses hidden"
                    style="max-width: unset"
                >
                    <h2>æ¿æ©‹å¾ŒåŸ”æ•™æœƒ</h2>
                    <p>å°ç£åŸºç£é•·è€æ•™æœƒï¼æ–°åŒ—å¸‚æ¿æ©‹å€</p>
                    <ul>
                        <li>
                            <strong>ä¸»æ—¥ç¦®æ‹œæ™‚é–“ï¼š</strong>å°èª 09:00ã€è¯èª
                            10:50ï¼ˆä»¥æ•™æœƒæœ€æ–°å…¬å‘Šç‚ºæº–ï¼‰ã€‚
                        </li>
                        <li>
                            åŸºç£æ•™é•·è€æ•™æœƒå¾æ¸…æœå‚³å…¥å°ç£ï¼Œç›®å‰å°ç£äººæ•¸æœ€å¤šçš„åŸºç£æ•™æœƒã€‚
                        </li>
                        <li>å°±ç®—ä½ ä¸æ˜¯ä¿¡å¾’ï¼Œä¹Ÿæ­¡è¿ä¾†åšç¦®æ‹œï¼Œèªè­˜ä¸»ã€‚</li>
                        <li>
                            <strong>åœ°å€ï¼š</strong>æ–°åŒ—å¸‚æ¿æ©‹å€é‡æ…¶è·¯ 276 ä¹‹ 1
                            è™Ÿ 3 æ¨“ã€‚
                        </li>
                        <li><strong>ç¶²ç«™ï¼š</strong>hpch.org.tw</li>
                    </ul>
                    <h2>AA Bible: è–ç¶“é–±è®€å°å·¥å…·</h2>
                    <h3>Access Anywhere Bible</h3>
                    <p>
                        <a
                            href="https://nicklawman.github.io/bible"
                            style="
                                display: inline-block;
                                padding: 10px 18px;
                                background-color: #ff9900;
                                color: #fff;
                                text-decoration: none;
                                border-radius: 6px;
                                font-weight: 600;
                                font-size: 16px;
                                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
                                transition: background-color 0.2s ease;
                            "
                            onmouseover="this.style.backgroundColor='#cc7a00'"
                            onmouseout="this.style.backgroundColor='#FF9900'"
                        >
                            AA Bible
                        </a>
                    </p>
                    <p>
                        <a href="https://nicklawman.github.io/bible"
                            ><img src="qrcode.png" width="200px"
                        /></a>
                    </p>
                    <p>
                        ä½¿å¾’è¡Œå‚³ 17:10-11
                        æåˆ°ï¼šåº‡å“©äºäººã€Œç”˜å¿ƒé ˜å—é€™é“ï¼Œå¤©å¤©æŸ¥è€ƒè–ç¶“ã€ã€‚
                    </p>
                    <p>ç°¡å–®ä¸å›‰å—¦ï¼Œå…å®‰è£ï¼Œé›¢ç·šå¯è®€ï¼Œä¸æœƒå·ä½ çš„ä»»ä½•è³‡æ–™ã€‚</p>
                    <p>
                        ç”±<a href="mailto:hellojohnbottle@gmail.com">æ°´ç“¶ç´„ç¿°</a
                        >è£½ä½œï¼Œè³‡æ–™æºè‡ªè–ç¶“å’Œåˆæœ¬ã€‚
                    </p>
                    <p>version 1.0</p>
                    <!-- Google tag (gtag.js) -->
                    <script
                        async
                        src="https://www.googletagmanager.com/gtag/js?id=G-Q1FFESLPVK"
                    ></script>
                    <script>
                        window.dataLayer = window.dataLayer || [];
                        function gtag() {
                            dataLayer.push(arguments);
                        }
                        gtag("js", new Date());

                        gtag("config", "G-Q1FFESLPVK");
                    </script>
                </div>
            </main>
        </div>

        <script>
            /* ---- constants ---- */
            const DEFAULT_BOOK_NAME = "é¦¬å¤ªç¦éŸ³";
            const DEFAULT_CHAPTER_NO = 1;

            const BOOKS_META = [
                {
                    heading: "èˆŠç´„",
                    groups: [
                        {
                            sub: "æ‘©è¥¿äº”æ›¸",
                            books: [
                                "å‰µä¸–è¨˜",
                                "å‡ºåŸƒåŠè¨˜",
                                "åˆ©æœªè¨˜",
                                "æ°‘æ•¸è¨˜",
                                "ç”³å‘½è¨˜",
                            ],
                        },
                        {
                            sub: "æ­·å²æ›¸",
                            books: [
                                "ç´„æ›¸äºè¨˜",
                                "å£«å¸«è¨˜",
                                "è·¯å¾—è¨˜",
                                "æ’’æ¯è€³è¨˜ä¸Š",
                                "æ’’æ¯è€³è¨˜ä¸‹",
                                "åˆ—ç‹ç´€ä¸Š",
                                "åˆ—ç‹ç´€ä¸‹",
                                "æ­·ä»£å¿—ä¸Š",
                                "æ­·ä»£å¿—ä¸‹",
                                "ä»¥æ–¯æ‹‰è¨˜",
                                "å°¼å¸Œç±³è¨˜",
                                "ä»¥æ–¯å¸–è¨˜",
                            ],
                        },
                        {
                            sub: "è©©æ­Œæ™ºæ…§æ›¸",
                            books: ["ç´„ä¼¯è¨˜", "è©©ç¯‡", "ç®´è¨€", "å‚³é“æ›¸", "é›…æ­Œ"],
                        },
                        {
                            sub: "å¤§å…ˆçŸ¥æ›¸",
                            books: [
                                "ä»¥è³½äºæ›¸",
                                "è€¶åˆ©ç±³æ›¸",
                                "è€¶åˆ©ç±³å“€æ­Œ",
                                "ä»¥è¥¿çµæ›¸",
                                "ä½†ä»¥ç†æ›¸",
                            ],
                        },
                        {
                            sub: "å°å…ˆçŸ¥æ›¸",
                            books: [
                                "ä½•è¥¿é˜¿æ›¸",
                                "ç´„ç¥æ›¸",
                                "é˜¿æ‘©å¸æ›¸",
                                "ä¿„å·´åº•äºæ›¸",
                                "ç´„æ‹¿æ›¸",
                                "å½Œè¿¦æ›¸",
                                "é‚£é´»æ›¸",
                                "å“ˆå·´è°·æ›¸",
                                "è¥¿ç•ªé›…æ›¸",
                                "å“ˆè©²æ›¸",
                                "æ’’è¿¦åˆ©äºæ›¸",
                                "ç‘ªæ‹‰åŸºæ›¸",
                            ],
                        },
                    ],
                },
                {
                    heading: "æ–°ç´„",
                    groups: [
                        {
                            sub: "å››æœ¬ç¦éŸ³æ›¸",
                            books: [
                                "é¦¬å¤ªç¦éŸ³",
                                "é¦¬å¯ç¦éŸ³",
                                "è·¯åŠ ç¦éŸ³",
                                "ç´„ç¿°ç¦éŸ³",
                            ],
                        },
                        { sub: "by è·¯åŠ ï¼šä¿ç¾…çš„å¸Œè‡˜å¥½å‹", books: ["ä½¿å¾’è¡Œå‚³"] },
                        {
                            sub: "by ä¿ç¾…",
                            books: [
                                "ç¾…é¦¬æ›¸",
                                "å“¥æ—å¤šå‰æ›¸",
                                "å“¥æ—å¤šå¾Œæ›¸",
                                "åŠ æ‹‰å¤ªæ›¸",
                                "ä»¥å¼—æ‰€æ›¸",
                                "è…“ç«‹æ¯”æ›¸",
                                "æ­Œç¾…è¥¿æ›¸",
                                "å¸–æ’’ç¾…å°¼è¿¦å‰æ›¸",
                                "å¸–æ’’ç¾…å°¼è¿¦å¾Œæ›¸",
                                "ææ‘©å¤ªå‰æ›¸",
                                "ææ‘©å¤ªå¾Œæ›¸",
                                "æå¤šæ›¸",
                                "è…“åˆ©é–€æ›¸",
                                "å¸Œä¼¯ä¾†æ›¸",
                            ],
                        },
                        { sub: "byé›…å„ï¼šè€¶ç©Œçš„å¼Ÿå¼Ÿ", books: ["é›…å„æ›¸"] },
                        {
                            sub: "by å½¼å¾—: ä½¿å¾’",
                            books: ["å½¼å¾—å‰æ›¸", "å½¼å¾—å¾Œæ›¸"],
                        },
                        {
                            sub: "by ç´„ç¿°ï¼šä½¿å¾’",
                            books: ["ç´„ç¿°ä¸€æ›¸", "ç´„ç¿°äºŒæ›¸", "ç´„ç¿°ä¸‰æ›¸"],
                        },
                        { sub: " by çŒ¶å¤§ï¼šè€¶ç©Œçš„å¼Ÿå¼Ÿ", books: ["çŒ¶å¤§æ›¸"] },
                        {
                            sub: " by ç´„ç¿°ï¼šä½¿å¾’(æœ‰ä¸åŒçœ‹æ³•ï¼‰",
                            books: ["å•Ÿç¤ºéŒ„"],
                        },
                    ],
                },
            ];

            const state = {
                data: null,
                orderedBooks: [],
                bookIdx: 0,
                chapIdx: 0,
                isMobile: false,
                openBookEl: null,
                summaries: null,
                summaryMap: new Map(),
            };

            /* helpers */
            function detectMobile() {
                const ua = navigator.userAgent || "";
                const likelyMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(ua);
                const small =
                    Math.min(window.innerWidth, window.innerHeight) < 900;
                return likelyMobile || small;
            }
            function presentBooksSet() {
                return new Set(state.data.books.map((b) => b.name));
            }
            function bookByIdx(i) {
                const n = state.orderedBooks[i];
                return state.data.books.find((b) => b.name === n);
            }
            function idxOfBook(name) {
                return state.orderedBooks.findIndex((n) => n === name);
            }
            function saveReading() {
                const name =
                    state.orderedBooks[state.bookIdx] || DEFAULT_BOOK_NAME;
                const chap =
                    bookByIdx(state.bookIdx)?.chapters?.[state.chapIdx]?.c ||
                    DEFAULT_CHAPTER_NO;
                localStorage.setItem("bookName", name);
                localStorage.setItem("chapterNo", String(chap));
            }
            function loadReading() {
                const name =
                    localStorage.getItem("bookName") || DEFAULT_BOOK_NAME;
                const chapNo = parseInt(
                    localStorage.getItem("chapterNo") || DEFAULT_CHAPTER_NO,
                    10,
                );
                return { name, chapNo };
            }

            function showBible() {
                document.getElementById("reader").classList.remove("hidden");
                document.getElementById("summaryPane").classList.add("hidden");
                document.getElementById("aboutChurch").classList.add("hidden");
            }
            function showSummaryHTML(html) {
                const pane = document.getElementById("summaryPane");
                pane.innerHTML = `<div class="doc">${html}</div>`;
                pane.classList.remove("hidden");
                document.getElementById("reader").classList.add("hidden");
                document.getElementById("aboutChurch").classList.add("hidden");
                requestAnimationFrame(() =>
                    window.scrollTo({ top: 0, behavior: "auto" }),
                );
            }
            function showChurch() {
                document.getElementById("reader").classList.add("hidden");
                document.getElementById("summaryPane").classList.add("hidden");
                document
                    .getElementById("aboutChurch")
                    .classList.remove("hidden");
            }

            function buildOrder() {
                const present = presentBooksSet();
                state.orderedBooks = [];
                BOOKS_META.forEach((sec) =>
                    sec.groups.forEach((gr) =>
                        gr.books.forEach((n) => {
                            if (present.has(n)) state.orderedBooks.push(n);
                        }),
                    ),
                );
            }

            function toggleDrawer() {
                document.body.classList.toggle("drawer-open");
            }

            function wireTopBar() {
                const titleEl = document.getElementById("bookTitle");
                const btnInline = document.getElementById("menuBtnInline");
                const fab = document.getElementById("menuFab");
                const backdrop = document.getElementById("backdrop");

                const clickToggle = () => toggleDrawer();
                titleEl.addEventListener("click", clickToggle);
                btnInline.addEventListener("click", clickToggle);
                fab.addEventListener("click", clickToggle);
                backdrop.addEventListener("click", () =>
                    document.body.classList.remove("drawer-open"),
                );

                document
                    .getElementById("prevBtn")
                    .addEventListener("click", gotoPrev);
                document
                    .getElementById("nextBtn")
                    .addEventListener("click", gotoNext);
                document
                    .getElementById("prevBookBtn")
                    .addEventListener("click", gotoPrevBook);
                document
                    .getElementById("nextBookBtn")
                    .addEventListener("click", gotoNextBook);

                window.addEventListener("keydown", (e) => {
                    if (e.key === "Escape")
                        document.body.classList.remove("drawer-open");
                    if (e.key === "ArrowLeft") {
                        e.preventDefault();
                        gotoPrev();
                    }
                    if (e.key === "ArrowRight") {
                        e.preventDefault();
                        gotoNext();
                    }
                });

                window.addEventListener("resize", () => {
                    const now = detectMobile();
                    if (now !== state.isMobile) {
                        state.isMobile = now;
                        document.body.classList.toggle(
                            "mobile",
                            state.isMobile,
                        );
                    }
                });
            }

            function updateTitle() {
                document.getElementById("bookTitle").textContent =
                    state.orderedBooks[state.bookIdx] || "â€”";
            }
            function renderChapters() {
                const area = document.getElementById("chapterArea");
                area.innerHTML = "";
                const book = bookByIdx(state.bookIdx);
                updateTitle();
                if (!book) return;
                book.chapters.forEach((ch, i) => {
                    const btn = document.createElement("button");
                    btn.textContent = ch.c;
                    btn.className = i === state.chapIdx ? "active" : "";
                    btn.onclick = () => {
                        state.chapIdx = i;
                        saveReading();
                        renderChapters();
                        renderChapter(true);
                        showBible();
                    };
                    area.appendChild(btn);
                });
            }
            function renderChapter() {
                const reader = document.getElementById("reader");
                const book = bookByIdx(state.bookIdx);
                const ch = book?.chapters?.[state.chapIdx];
                if (!ch) {
                    reader.innerHTML = '<div class="muted">æœ¬æ›¸æ²’æœ‰ç« ç¯€</div>';
                    return;
                }
                let html = `<div class="muted" id="top">${book.name} ç¬¬ ${ch.c} ç« </div>`;
                ch.verses.forEach((v) => {
                    const id = v.v === 1 ? ` id="v-${ch.c}-1"` : "";
                    html += `<div class="verse"${id}><span class="vno">${ch.c}:${v.v}</span>${escapeHtml(v.t)}</div>`;
                });
                reader.innerHTML = html;
            }

            function gotoPrev() {
                const book = bookByIdx(state.bookIdx);
                if (!book) return;
                if (state.chapIdx > 0) {
                    state.chapIdx--;
                } else if (state.bookIdx > 0) {
                    state.bookIdx--;
                    state.chapIdx = 0;
                } else return;
                saveReading();
                renderChapters();
                renderChapter(true);
                showBible();
            }
            function gotoNext() {
                const book = bookByIdx(state.bookIdx);
                if (!book) return;
                if (state.chapIdx < book.chapters.length - 1) {
                    state.chapIdx++;
                } else if (state.bookIdx < state.orderedBooks.length - 1) {
                    state.bookIdx++;
                    state.chapIdx = 0;
                } else return;
                saveReading();
                renderChapters();
                renderChapter(true);
                showBible();
            }
            function gotoPrevBook() {
                if (state.bookIdx > 0) {
                    state.bookIdx--;
                    state.chapIdx = 0;
                    saveReading();
                    renderChapters();
                    renderChapter(true);
                    showBible();
                }
            }
            function gotoNextBook() {
                if (state.bookIdx < state.orderedBooks.length - 1) {
                    state.bookIdx++;
                    state.chapIdx = 0;
                    saveReading();
                    renderChapters();
                    renderChapter(true);
                    showBible();
                }
            }

            function buildDrawer() {
                const root = document.getElementById("drawerContent");
                root.innerHTML = "";

                // footer controls
                const setPx = (px) => {
                    document.documentElement.style.setProperty(
                        "--fs",
                        px + "px",
                    );
                    localStorage.setItem("fsPx", String(px));
                };
                const clamp = (v) => Math.max(14, Math.min(36, v));
                document.getElementById("fsDec").onclick = () => {
                    const cur =
                        parseInt(
                            getComputedStyle(
                                document.documentElement,
                            ).getPropertyValue("--fs"),
                        ) || 28;
                    setPx(clamp(cur - 2));
                };
                document.getElementById("fsInc").onclick = () => {
                    const cur =
                        parseInt(
                            getComputedStyle(
                                document.documentElement,
                            ).getPropertyValue("--fs"),
                        ) || 28;
                    setPx(clamp(cur + 2));
                };
                document.getElementById("themeBtn").onclick = () => {
                    const cur =
                        document.documentElement.getAttribute("data-theme") ||
                        "dark";
                    const next = cur === "dark" ? "light" : "dark";
                    document.documentElement.setAttribute("data-theme", next);
                    localStorage.setItem("theme", next);
                };
                document.getElementById("churchBtn").onclick = () => {
                    showChurch();
                    document.body.classList.remove("drawer-open");
                };

                const present = new Set(state.data.books.map((b) => b.name));
                BOOKS_META.forEach((section) => {
                    const h = document.createElement("div");
                    h.className = "group-title";
                    h.textContent = section.heading;
                    root.appendChild(h);
                    section.groups.forEach((gr) => {
                        const sub = document.createElement("div");
                        sub.className = "sub-title";
                        sub.textContent = gr.sub;
                        root.appendChild(sub);

                        gr.books.forEach((name) => {
                            if (!present.has(name)) return;
                            const book = state.data.books.find(
                                (b) => b.name === name,
                            );

                            const bookRow = document.createElement("div");
                            bookRow.className = "book-item";
                            const left = document.createElement("div");
                            left.className = "book-left";
                            const arrow = document.createElement("span");
                            arrow.className = "arrow";
                            arrow.textContent = "â–¶";
                            const label = document.createElement("span");
                            label.className = "book-name";
                            label.textContent = name;
                            left.append(arrow, label);

                            const btnWrap = document.createElement("div");
                            const sumBtn = document.createElement("button");
                            sumBtn.className = "pill";
                            sumBtn.textContent = "æ‘˜è¦";
                            const goBtn = document.createElement("button");
                            goBtn.className = "pill";
                            goBtn.textContent = "å‰å¾€";
                            btnWrap.append(sumBtn, goBtn);

                            bookRow.append(left, btnWrap);
                            root.appendChild(bookRow);

                            const chapList = document.createElement("div");
                            chapList.className = "chap-list";
                            (book?.chapters || []).forEach((ch, i) => {
                                const cbtn = document.createElement("button");
                                cbtn.className = "pill";
                                cbtn.textContent = ch.c;
                                cbtn.onclick = (ev) => {
                                    ev.stopPropagation();
                                    state.bookIdx = idxOfBook(name);
                                    state.chapIdx = i;
                                    saveReading();
                                    renderChapters();
                                    renderChapter(true);
                                    showBible();
                                    document.body.classList.remove(
                                        "drawer-open",
                                    );
                                };
                                chapList.appendChild(cbtn);
                            });
                            root.appendChild(chapList);

                            left.addEventListener("click", () => {
                                if (
                                    state.openBookEl &&
                                    state.openBookEl !== bookRow
                                )
                                    state.openBookEl.classList.remove("open");
                                const willOpen =
                                    !bookRow.classList.contains("open");
                                if (willOpen) {
                                    bookRow.classList.add("open");
                                    state.openBookEl = bookRow;
                                } else {
                                    bookRow.classList.remove("open");
                                    state.openBookEl = null;
                                }
                                state.bookIdx = idxOfBook(name);
                                state.chapIdx = 0;
                                saveReading();
                                renderChapters();
                                renderChapter(true);
                                showBible();
                            });

                            goBtn.addEventListener("click", (ev) => {
                                ev.stopPropagation();
                                state.bookIdx = idxOfBook(name);
                                state.chapIdx = 0;
                                saveReading();
                                renderChapters();
                                renderChapter(true);
                                showBible();
                                document.body.classList.remove("drawer-open");
                            });

                            sumBtn.addEventListener("click", async (ev) => {
                                ev.stopPropagation();
                                await ensureSummaries();
                                const rec = state.summaryMap.get(name);
                                if (rec && rec.book_html_summary)
                                    showSummaryHTML(rec.book_html_summary);
                                else
                                    showSummaryHTML(
                                        `<h1>${name}</h1><p>å°šç„¡æ‘˜è¦è³‡æ–™ã€‚</p>`,
                                    );
                                document.body.classList.remove("drawer-open");
                            });
                        });
                    });
                });
            }

            async function ensureSummaries() {
                if (state.summaries) return;
                try {
                    const res = await fetch("summary.json", {
                        cache: "no-cache",
                    });
                    state.summaries = await res.json();
                    const arr = Array.isArray(state.summaries)
                        ? state.summaries
                        : state.summaries.records || [];
                    arr.forEach((r) => state.summaryMap.set(r.book_name, r));
                } catch (e) {
                    console.warn("Load summary.json failed:", e);
                    state.summaries = [];
                }
            }

            function escapeHtml(s) {
                return s
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
            }

            /* ====== æ–°å¢ï¼šå·¦å³æ»‘æ‰‹å‹¢ï¼Œå·¦æ»‘â†’ä¸‹ä¸€ç« ï¼Œå³æ»‘â†’ä¸Šä¸€ç«  ====== */
            function enableSwipe(container, onLeft, onRight, opts = {}) {
                const THRESHOLD = opts.threshold ?? 60; // è§¸ç™¼æ‰€éœ€æ°´å¹³è·é›¢(px)
                const MAX_ANGLE = opts.maxAngle ?? 35; // èˆ‡æ°´å¹³æœ€å¤§å¤¾è§’(åº¦)
                const MAX_DURATION = opts.maxDuration ?? 800; // æœ€é•·æ‰‹å‹¢æ™‚é–“(ms)

                let startX = 0,
                    startY = 0,
                    t0 = 0,
                    tracking = false;

                container.addEventListener(
                    "touchstart",
                    (ev) => {
                        if (!state.isMobile) return;
                        const t = ev.changedTouches[0];
                        startX = t.clientX;
                        startY = t.clientY;
                        t0 = Date.now();
                        tracking = true;
                    },
                    { passive: true },
                );

                container.addEventListener(
                    "touchend",
                    (ev) => {
                        if (!tracking || !state.isMobile) return;
                        tracking = false;

                        const t = ev.changedTouches[0];
                        const dx = t.clientX - startX;
                        const dy = t.clientY - startY;
                        const dt = Date.now() - t0;

                        const absDx = Math.abs(dx),
                            absDy = Math.abs(dy);
                        const angle =
                            (Math.atan2(absDy, absDx) * 180) / Math.PI;

                        // ç¬¦åˆæ™‚é–“èˆ‡æ°´å¹³ä½ç§»ï¼Œä¸”ä¸æ˜¯éåº¦å‚ç›´çš„æ»‘å‹•
                        if (
                            dt <= MAX_DURATION &&
                            absDx >= THRESHOLD &&
                            angle <= MAX_ANGLE
                        ) {
                            if (dx < 0)
                                onLeft?.(); // å¾€å·¦æ»‘ï¼šä¸‹ä¸€ç« 
                            else onRight?.(); // å¾€å³æ»‘ï¼šä¸Šä¸€ç« 
                        }
                    },
                    { passive: true },
                );
            }

            async function loadData() {
                const theme = localStorage.getItem("theme") || "dark";
                document.documentElement.setAttribute("data-theme", theme);
                const fs = +(localStorage.getItem("fsPx") || 28);
                document.documentElement.style.setProperty("--fs", fs + "px");

                state.isMobile = detectMobile();
                document.body.classList.toggle("mobile", state.isMobile);

                const res = await fetch("bible.json", { cache: "no-cache" });
                state.data = await res.json();

                buildOrder();

                const saved = loadReading();
                const bIdx = idxOfBook(saved.name);
                state.bookIdx =
                    bIdx >= 0
                        ? bIdx
                        : idxOfBook(DEFAULT_BOOK_NAME) >= 0
                          ? idxOfBook(DEFAULT_BOOK_NAME)
                          : 0;
                const book = bookByIdx(state.bookIdx);
                let cIdx = 0;
                if (book && Array.isArray(book.chapters)) {
                    const found = book.chapters.findIndex(
                        (c) => Number(c.c) === Number(saved.chapNo),
                    );
                    cIdx = found >= 0 ? found : 0;
                }
                state.chapIdx = cIdx;

                buildDrawer();
                wireTopBar();
                renderChapters();
                renderChapter(true);
                showBible();

                /* ====== æ–°å¢ï¼šæ›ä¸Šæ»‘å‹•äº‹ä»¶ï¼ˆç¶“æ–‡å€ & æ‘˜è¦å€ï¼‰====== */
                const readerEl = document.getElementById("reader");
                const summaryEl = document.getElementById("summaryPane");
                enableSwipe(
                    readerEl,
                    () => gotoNext(),
                    () => gotoPrev(),
                );
                enableSwipe(
                    summaryEl,
                    () => gotoNext(),
                    () => gotoPrev(),
                );
            }

            if ("serviceWorker" in navigator) {
                window.addEventListener("load", () =>
                    navigator.serviceWorker.register("sw.js"),
                );
            }
            loadData();
        </script>
    </body>
</html>
