<!doctype html>
<html lang="zh-Hant">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <link rel="manifest" href="manifest.webmanifest" />
        <meta name="theme-color" content="#0d6efd" />
        <title>ËÅñÁ∂ìÂíåÂêàÊú¨</title>
        <style>
            :root {
                /* THEME (dark) */
                --bg: #0b0e12;
                --fg: #e8e8e8;
                --muted: #9aa0a6;
                --acc: #0d6efd;
                --card: #151a20;
                --line: #24303a;
                --chip: #10161c;
                --chip-line: #2b3947;
                --mark-bg: #2b3f64;
                /* FONT size default */
                --fs: 1.8rem;
            }
            :root[data-theme="light"] {
                --bg: #ffffff;
                --fg: #111827;
                --muted: #6b7280;
                --acc: #0d6efd;
                --card: #f9fafb;
                --line: #e5e7eb;
                --chip: #ffffff;
                --chip-line: #e5e7eb;
                --mark-bg: #fde68a;
            }
            html,
            body {
                margin: 0;
                height: 100%;
                background: var(--bg);
                color: var(--fg);
                font-family:
                    system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    Helvetica,
                    Arial;
            }
            body {
                font-size: var(--fs);
            }
            header {
                position: sticky;
                top: 0;
                background: var(--card);
                padding: 0.6rem 0.9rem;
                border-bottom: 1px solid var(--line);
                z-index: 10;
                display: flex;
                gap: 0.75rem;
                align-items: center;
                flex-wrap: wrap;
            }
            h1 {
                font-size: 1.05rem;
                margin: 0;
            }
            select,
            input[type="search"],
            input[type="range"] {
                background: var(--chip);
                color: var(--fg);
                border: 1px solid var(--chip-line);
                border-radius: 0.5rem;
                padding: 0.4rem 0.6rem;
                font-size: 0.9rem;
            }
            input[type="range"] {
                padding: 0;
                height: 1.75rem;
            }
            .content {
                display: grid;
                grid-template-columns: 320px 1fr;
                gap: 1rem;
                padding: 1rem;
            }
            .sidebar {
                background: var(--card);
                border: 1px solid var(--line);
                border-radius: 0.5rem;
                padding: 0.75rem;
                overflow: auto;
                max-height: calc(100dvh - 92px);
            }
            .group-title {
                margin: 0.75rem 0 0.25rem;
                font-weight: 700;
            }
            .sub-title {
                margin: 0.5rem 0 0.25rem;
                font-weight: 600;
                color: var(--muted);
                font-size: 0.95rem;
            }
            .book-list {
                display: flex;
                flex-direction: column;
                gap: 0.15rem;
                margin: 0.25rem 0 0.75rem;
            }
            .book {
                display: flex;
                gap: 0.5rem;
                align-items: center;
            }
            .book button {
                background: transparent;
                color: var(--fg);
                border: 0;
                cursor: pointer;
                text-align: left;
                padding: 0.25rem 0.35rem;
                border-radius: 0.3rem;
            }
            .book button:hover {
                background: var(--chip);
                border: 1px solid var(--chip-line);
            }
            .chapters {
                display: flex;
                flex-wrap: wrap;
                gap: 0.35rem;
                margin: 0.25rem 0;
            }
            .chapters button {
                background: var(--chip);
                border: 1px solid var(--chip-line);
                color: var(--fg);
                padding: 0.3rem 0.45rem;
                border-radius: 0.4rem;
                cursor: pointer;
                font-size: 0.95rem;
            }
            .chapters button.active {
                background: var(--acc);
                border-color: var(--acc);
                color: #fff;
            }
            .verses {
                background: var(--card);
                border: 1px solid var(--line);
                border-radius: 0.5rem;
                padding: 1rem;
                line-height: 1.8;
                max-width: 80ch;
            }
            .verse {
                margin: 0.12rem 0;
            }
            .vno {
                color: var(--muted);
                font-size: 0.9rem;
                margin-right: 0.35rem;
            }
            .muted {
                color: var(--muted);
            }
            .toolbar {
                display: flex;
                gap: 0.5rem;
                align-items: center;
                flex-wrap: wrap;
            }
            .badge {
                display: inline-block;
                background: #152237;
                border: 1px solid #20314a;
                color: #aac4ff;
                font-size: 0.75rem;
                padding: 0.1rem 0.4rem;
                border-radius: 0.4rem;
                margin-left: 0.5rem;
            }
            .search-info {
                margin-left: auto;
                font-size: 0.9rem;
                color: var(--muted);
            }
            .toggle {
                display: inline-flex;
                align-items: center;
                gap: 0.35rem;
                padding: 0.25rem 0.45rem;
                border: 1px solid var(--chip-line);
                border-radius: 0.5rem;
                background: var(--chip);
                cursor: pointer;
                font-size: 0.9rem;
            }
            mark {
                background: var(--mark-bg);
                color: inherit;
                padding: 0.05rem 0.15rem;
                border-radius: 0.2rem;
            }

            /* Mobile/desktop visibility helpers */
            .only-desktop {
                display: flex;
            }
            .only-mobile {
                display: none;
            }
            body.mobile .only-desktop {
                display: none;
            }
            body.mobile .only-mobile {
                display: inline-flex;
            }

            /* Mobile layout tweaks */
            body.mobile .content {
                grid-template-columns: 1fr;
            }
            body.mobile .sidebar {
                display: none;
            }
            body.mobile header {
                gap: 0.5rem;
            }
            body.mobile #q {
                min-width: 12ch;
            }
            body.mobile .verses {
                max-width: unset;
            }
        </style>
    </head>
    <body>
        <header>
            <h1>ËÅñÁ∂ìÂíåÂêàÊú¨ <span class="badge">PWA</span></h1>

            <!-- Theme toggle -->
            <button id="themeBtn" class="toggle" title="ÂàáÊèõ‰∏ªÈ°å">
                üåû / üåö
            </button>

            <!-- Desktop: slider -->
            <label class="muted only-desktop" for="fs">Â≠óÈ´îÔºö</label>
            <input
                id="fs"
                class="only-desktop"
                type="range"
                min="14"
                max="36"
                step="1"
                value="28"
            />
            <span id="fsVal" class="muted only-desktop">28px</span>

            <!-- Book dropdown (shared) -->
            <label class="muted">Êõ∏Âç∑Ôºö</label>
            <select id="bookSel"></select>

            <!-- Mobile: font size A-/A+ -->
            <div
                class="only-mobile"
                id="fsBtns"
                style="gap: 0.25rem; align-items: center"
            >
                <button id="fsDec" class="toggle" title="Ê∏õÂ∞èÂ≠óÈ´î">A‚àí</button>
                <button id="fsInc" class="toggle" title="ÊîæÂ§ßÂ≠óÈ´î">A+</button>
            </div>

            <!-- Chapter buttons -->
            <span id="chapterArea" class="chapters"></span>

            <!-- Search -->
            <input
                id="q"
                type="search"
                placeholder="ÂÖ®ÊñáÊêúÂ∞ãÔºàÈõ¢Á∑öÔºâ"
                style="min-width: 16ch"
            />
            <div class="search-info" id="searchInfo"></div>
        </header>

        <div class="content">
            <aside class="sidebar" id="sidebar"></aside>
            <main>
                <div id="reader" class="verses"></div>
            </main>
        </div>

        <script>
            /* ---------- Canonical groups & order (66) ---------- */
            const BOOKS_META = [
                {
                    heading: "ËàäÁ¥Ñ",
                    groups: [
                        {
                            sub: "Êë©Ë•ø‰∫îÊõ∏",
                            books: [
                                "Ââµ‰∏ñË®ò",
                                "Âá∫ÂüÉÂèäË®ò",
                                "Âà©Êú™Ë®ò",
                                "Ê∞ëÊï∏Ë®ò",
                                "Áî≥ÂëΩË®ò",
                            ],
                        },
                        {
                            sub: "Ê≠∑Âè≤Êõ∏",
                            books: [
                                "Á¥ÑÊõ∏‰∫ûË®ò",
                                "Â£´Â∏´Ë®ò",
                                "Ë∑ØÂæóË®ò",
                                "ÊííÊØçËÄ≥Ë®ò‰∏ä",
                                "ÊííÊØçËÄ≥Ë®ò‰∏ã",
                                "ÂàóÁéãÁ¥Ä‰∏ä",
                                "ÂàóÁéãÁ¥Ä‰∏ã",
                                "Ê≠∑‰ª£Âøó‰∏ä",
                                "Ê≠∑‰ª£Âøó‰∏ã",
                                "‰ª•ÊñØÊãâË®ò",
                                "Â∞ºÂ∏åÁ±≥Ë®ò",
                                "‰ª•ÊñØÂ∏ñË®ò",
                            ],
                        },
                        {
                            sub: "Ë©©Ê≠åÊô∫ÊÖßÊõ∏",
                            books: ["Á¥Ñ‰ºØË®ò", "Ë©©ÁØá", "ÁÆ¥Ë®Ä", "ÂÇ≥ÈÅìÊõ∏", "ÈõÖÊ≠å"],
                        },
                        {
                            sub: "Â§ßÂÖàÁü•Êõ∏",
                            books: [
                                "‰ª•Ë≥Ω‰∫ûÊõ∏",
                                "ËÄ∂Âà©Á±≥Êõ∏",
                                "ËÄ∂Âà©Á±≥ÂìÄÊ≠å",
                                "‰ª•Ë•øÁµêÊõ∏",
                                "‰ΩÜ‰ª•ÁêÜÊõ∏",
                            ],
                        },
                        {
                            sub: "Â∞èÂÖàÁü•Êõ∏",
                            books: [
                                "‰ΩïË•øÈòøÊõ∏",
                                "Á¥ÑÁè•Êõ∏",
                                "ÈòøÊë©Âè∏Êõ∏",
                                "‰øÑÂ∑¥Â∫ï‰∫ûÊõ∏",
                                "Á¥ÑÊãøÊõ∏",
                                "ÂΩåËø¶Êõ∏",
                                "ÈÇ£È¥ªÊõ∏",
                                "ÂìàÂ∑¥Ë∞∑Êõ∏",
                                "Ë•øÁï™ÈõÖÊõ∏",
                                "ÂìàË©≤Êõ∏",
                                "ÊííËø¶Âà©‰∫ûÊõ∏",
                                "Áë™ÊãâÂü∫Êõ∏",
                            ],
                        },
                    ],
                },
                {
                    heading: "Êñ∞Á¥Ñ",
                    groups: [
                        {
                            sub: "Á¶èÈü≥Êõ∏",
                            books: [
                                "È¶¨Â§™Á¶èÈü≥",
                                "È¶¨ÂèØÁ¶èÈü≥",
                                "Ë∑ØÂä†Á¶èÈü≥",
                                "Á¥ÑÁø∞Á¶èÈü≥",
                            ],
                        },
                        {
                            sub: "‰ΩøÂæíË°åÂÇ≥-by Ë∑ØÂä†Ôºö‰øùÁæÖÁöÑÂ∏åËáòÂ•ΩÂèã",
                            books: ["‰ΩøÂæíË°åÂÇ≥"],
                        },
                        {
                            sub: "‰øùÁæÖÊõ∏‰ø°",
                            books: [
                                "ÁæÖÈ¶¨Êõ∏",
                                "Âì•ÊûóÂ§öÂâçÊõ∏",
                                "Âì•ÊûóÂ§öÂæåÊõ∏",
                                "Âä†ÊãâÂ§™Êõ∏",
                                "‰ª•ÂºóÊâÄÊõ∏",
                                "ËÖìÁ´ãÊØîÊõ∏",
                                "Ê≠åÁæÖË•øÊõ∏",
                                "Â∏ñÊííÁæÖÂ∞ºËø¶ÂâçÊõ∏",
                                "Â∏ñÊííÁæÖÂ∞ºËø¶ÂæåÊõ∏",
                                "ÊèêÊë©Â§™ÂâçÊõ∏",
                                "ÊèêÊë©Â§™ÂæåÊõ∏",
                                "ÊèêÂ§öÊõ∏",
                                "ËÖìÂà©ÈñÄÊõ∏",
                                "Â∏å‰ºØ‰æÜÊõ∏",
                            ],
                        },
                        { sub: "byÈõÖÂêÑÔºöËÄ∂Á©åÁöÑÂºüÂºü", books: ["ÈõÖÂêÑÊõ∏"] },
                        {
                            sub: "by ÂΩºÂæó: ‰ΩøÂæí",
                            books: ["ÂΩºÂæóÂâçÊõ∏", "ÂΩºÂæóÂæåÊõ∏"],
                        },
                        {
                            sub: "by Á¥ÑÁø∞Ôºö‰ΩøÂæí",
                            books: ["Á¥ÑÁø∞‰∏ÄÊõ∏", "Á¥ÑÁø∞‰∫åÊõ∏", "Á¥ÑÁø∞‰∏âÊõ∏"],
                        },
                        { sub: " byÁå∂Â§ß: ËÄ∂Á©åÂºüÂºü", books: ["Áå∂Â§ßÊõ∏"] },
                        { sub: " by Á¥ÑÁø∞ÔºöÂèØËÉΩÊòØ‰ΩøÂæí", books: ["ÂïüÁ§∫ÈåÑ"] },
                    ],
                },
            ];

            const state = {
                data: null,
                orderedBooks: [],
                bookIdx: 0,
                chapIdx: 0,
                q: "",
                isMobile: false,
            };

            function detectMobile() {
                const ua = navigator.userAgent || "";
                const likelyMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(ua);
                const smallScreen =
                    Math.min(window.innerWidth, window.innerHeight) < 900;
                return likelyMobile || smallScreen;
            }

            async function loadData() {
                // Theme + font
                const theme = localStorage.getItem("theme") || "dark";
                document.documentElement.setAttribute("data-theme", theme);
                const fs = +(localStorage.getItem("fsPx") || 28);
                document.documentElement.style.setProperty("--fs", fs + "px");

                state.isMobile = detectMobile();
                document.body.classList.toggle("mobile", state.isMobile);

                const res = await fetch("bible.json", { cache: "no-cache" });
                state.data = await res.json();

                buildSidebarAndOrder(); // no-op on mobile (hidden), but we still compute order
                buildDropdown();
                wireControls();
                renderChapters();
                renderChapter();
            }

            function wireControls() {
                // Theme
                document
                    .getElementById("themeBtn")
                    .addEventListener("click", () => {
                        const cur =
                            document.documentElement.getAttribute(
                                "data-theme",
                            ) || "dark";
                        const next = cur === "dark" ? "light" : "dark";
                        document.documentElement.setAttribute(
                            "data-theme",
                            next,
                        );
                        localStorage.setItem("theme", next);
                    });

                // Desktop font slider
                const fsInput = document.getElementById("fs");
                const fsVal = document.getElementById("fsVal");
                const currentFs =
                    parseInt(
                        getComputedStyle(
                            document.documentElement,
                        ).getPropertyValue("--fs"),
                    ) || 28;
                fsInput.value = currentFs;
                fsVal.textContent = currentFs + "px";
                fsInput.addEventListener("input", (e) => {
                    const px = +e.target.value;
                    document.documentElement.style.setProperty(
                        "--fs",
                        px + "px",
                    );
                    fsVal.textContent = px + "px";
                    localStorage.setItem("fsPx", String(px));
                });

                // Mobile A-/A+
                const fsDec = document.getElementById("fsDec");
                const fsInc = document.getElementById("fsInc");
                if (fsDec && fsInc) {
                    const step = 2;
                    const clamp = (v) => Math.max(14, Math.min(36, v));
                    const setPx = (px) => {
                        document.documentElement.style.setProperty(
                            "--fs",
                            px + "px",
                        );
                        localStorage.setItem("fsPx", String(px));
                        // keep slider in sync (hidden on mobile but ok)
                        document.getElementById("fs").value = px;
                        document.getElementById("fsVal").textContent =
                            px + "px";
                    };
                    fsDec.addEventListener("click", () => {
                        const cur = parseInt(
                            getComputedStyle(
                                document.documentElement,
                            ).getPropertyValue("--fs"),
                        );
                        setPx(clamp(cur - step));
                    });
                    fsInc.addEventListener("click", () => {
                        const cur = parseInt(
                            getComputedStyle(
                                document.documentElement,
                            ).getPropertyValue("--fs"),
                        );
                        setPx(clamp(cur + step));
                    });
                }

                // Search
                document.getElementById("q").addEventListener("input", (e) => {
                    state.q = e.target.value.trim();
                    if (state.q) renderSearch(state.q);
                    else renderChapter();
                });

                // Book dropdown
                document
                    .getElementById("bookSel")
                    .addEventListener("change", (e) => {
                        state.bookIdx = +e.target.value;
                        state.chapIdx = 0;
                        renderChapters();
                        renderChapter();
                        scrollSidebarToActive();
                    });

                // Resize: re-detect mobile if rotated
                window.addEventListener("resize", () => {
                    const mobile = detectMobile();
                    if (mobile !== state.isMobile) {
                        state.isMobile = mobile;
                        document.body.classList.toggle(
                            "mobile",
                            state.isMobile,
                        );
                    }
                });
            }

            function presentBooksSet() {
                return new Set(state.data.books.map((b) => b.name));
            }

            function buildSidebarAndOrder() {
                const present = presentBooksSet();
                state.orderedBooks = [];
                let idx = 0;

                const sidebar = document.getElementById("sidebar");
                sidebar.innerHTML = "";

                BOOKS_META.forEach((section) => {
                    // Heading (ËàäÁ¥Ñ/Êñ∞Á¥Ñ)
                    if (!state.isMobile) {
                        const h = document.createElement("div");
                        h.className = "group-title";
                        h.textContent = section.heading;
                        sidebar.appendChild(h);
                    }
                    section.groups.forEach((gr) => {
                        if (!state.isMobile) {
                            const sub = document.createElement("div");
                            sub.className = "sub-title";
                            sub.textContent = gr.sub;
                            sidebar.appendChild(sub);
                        }
                        const list = document.createElement("div");
                        list.className = "book-list";

                        gr.books.forEach((name) => {
                            if (!present.has(name)) return;
                            state.orderedBooks.push(name);
                            if (!state.isMobile) {
                                const row = document.createElement("div");
                                row.className = "book";
                                const btn = document.createElement("button");
                                btn.textContent = name;
                                btn.onclick = () => {
                                    state.bookIdx = idxOfBook(name);
                                    state.chapIdx = 0;
                                    updateDropdownSelection();
                                    renderChapters();
                                    renderChapter();
                                    highlightActiveBookInSidebar();
                                };
                                row.appendChild(btn);
                                list.appendChild(row);
                            }
                        });
                        if (!state.isMobile) sidebar.appendChild(list);
                    });
                });
                highlightActiveBookInSidebar();
            }

            function idxOfBook(name) {
                return state.orderedBooks.findIndex((n) => n === name);
            }

            function highlightActiveBookInSidebar() {
                if (state.isMobile) return;
                const sidebar = document.getElementById("sidebar");
                sidebar
                    .querySelectorAll(".book button")
                    .forEach((b) => b.classList.remove("active"));
                const activeName = state.orderedBooks[state.bookIdx];
                const btns = [
                    ...sidebar.querySelectorAll(".book button"),
                ].filter((b) => b.textContent === activeName);
                if (btns[0]) btns[0].classList.add("active");
            }

            function scrollSidebarToActive() {
                if (state.isMobile) return;
                const sidebar = document.getElementById("sidebar");
                const activeName = state.orderedBooks[state.bookIdx];
                const btn = [...sidebar.querySelectorAll(".book button")].find(
                    (b) => b.textContent === activeName,
                );
                if (btn) btn.scrollIntoView({ block: "nearest" });
            }

            function buildDropdown() {
                const sel = document.getElementById("bookSel");
                sel.innerHTML = "";
                state.orderedBooks.forEach((name, i) => {
                    const opt = document.createElement("option");
                    opt.value = i;
                    opt.textContent = name;
                    sel.appendChild(opt);
                });
                updateDropdownSelection();
            }

            function updateDropdownSelection() {
                const sel = document.getElementById("bookSel");
                sel.value = String(state.bookIdx);
            }

            function bookByOrderedIndex(i) {
                const name = state.orderedBooks[i];
                return state.data.books.find((b) => b.name === name);
            }

            function renderChapters() {
                const area = document.getElementById("chapterArea");
                area.innerHTML = "";
                const book = bookByOrderedIndex(state.bookIdx);
                if (!book) {
                    area.textContent = "Êú¨Êõ∏Âç∑‰∏çÂ≠òÂú®";
                    return;
                }
                book.chapters.forEach((ch, i) => {
                    const btn = document.createElement("button");
                    btn.textContent = ch.c;
                    btn.className = i === state.chapIdx ? "active" : "";
                    btn.onclick = () => {
                        state.chapIdx = i;
                        document.getElementById("q").value = "";
                        state.q = "";
                        renderChapters();
                        renderChapter();
                    };
                    area.appendChild(btn);
                });
            }

            function renderChapter() {
                const reader = document.getElementById("reader");
                const info = document.getElementById("searchInfo");
                info.textContent = "";
                const book = bookByOrderedIndex(state.bookIdx);
                const ch = book?.chapters?.[state.chapIdx];
                if (!ch) {
                    reader.innerHTML = '<div class="muted">Êú¨Êõ∏Ê≤íÊúâÁ´†ÁØÄ</div>';
                    return;
                }

                let html = `<div class="muted">${book.name} Á¨¨ ${ch.c} Á´†</div>`;
                ch.verses.forEach((v) => {
                    html += `<div class="verse"><span class="vno">${ch.c}:${v.v}</span>${escapeHtml(v.t)}</div>`;
                });
                reader.innerHTML = html;
                highlightActiveBookInSidebar();
            }

            function renderSearch(q) {
                const reader = document.getElementById("reader");
                const info = document.getElementById("searchInfo");
                const re = new RegExp(
                    q.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"),
                    "i",
                );
                let total = 0;
                let out = [];
                for (const name of state.orderedBooks) {
                    const book = state.data.books.find((b) => b.name === name);
                    if (!book) continue;
                    for (const ch of book.chapters) {
                        let printedHeader = false;
                        for (const v of ch.verses) {
                            if (re.test(v.t)) {
                                total++;
                                if (!printedHeader) {
                                    out.push(
                                        `<div class="muted" style="margin-top:.8rem">${book.name} Á¨¨ ${ch.c} Á´†</div>`,
                                    );
                                    printedHeader = true;
                                }
                                const txt = escapeHtml(v.t).replace(
                                    re,
                                    (m) => `<mark>${m}</mark>`,
                                );
                                out.push(
                                    `<div class="verse"><span class="vno">${ch.c}:${v.v}</span>${txt}</div>`,
                                );
                            }
                        }
                    }
                }
                info.textContent = total ? `ÊâæÂà∞ ${total} Á≠Ü` : "Êú™ÊâæÂà∞ÁµêÊûú";
                reader.innerHTML = out.length
                    ? out.join("")
                    : '<div class="muted">Ê≤íÊúâÁ¨¶ÂêàÁöÑÁµêÊûú</div>';
            }

            function escapeHtml(s) {
                return s
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
            }

            // PWA SW
            if ("serviceWorker" in navigator) {
                window.addEventListener("load", () => {
                    navigator.serviceWorker.register("sw.js");
                });
            }

            loadData();
        </script>
    </body>
</html>
