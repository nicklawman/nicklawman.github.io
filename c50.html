<!doctype html>
<html lang="zh-Hant">
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width,initial-scale=1,viewport-fit=cover"
        />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-title" content="Prague Pilgrim" />
        <meta name="apple-mobile-web-app-status-bar-style" content="default" />
        <meta name="theme-color" content="#0A84FF" />
        <title>NickÁöÑÊúùËÅñ‰πãË∑Ø-Â∏ÉÊãâÊ†º50ÊïôÂ†Ç</title>
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""
        />
        <style>
            :root {
                --brand: #0a84ff;
            }
            html,
            body {
                height: 100%;
                margin: 0;
                font:
                    14px/1.4 -apple-system,
                    BlinkMacSystemFont,
                    Segoe UI,
                    Arial;
            }
            #map {
                height: 100%;
            }
            .meta-bar {
                position: fixed;
                left: 10px;
                top: 10px;
                z-index: 1000;
                background: rgba(255, 255, 255, 0.92);
                border-radius: 10px;
                padding: 8px 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.12);
            }
            .legend {
                font-size: 12px;
                color: #555;
            }
            .num-marker {
                background: #e63946;
                color: #fff;
                font-weight: 700;
                border: 2px solid #fff;
                border-radius: 16px;
                width: 28px;
                height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 0 6px rgba(0, 0, 0, 0.3);
            }
            .leaflet-popup-content h3 {
                margin: 0 0 6px;
                font-size: 15px;
            }
            .leaflet-popup-content p {
                margin: 0 0 8px;
                font-size: 13px;
            }
            .popup-actions a,
            .popup-actions button {
                display: inline-block;
                padding: 6px 10px;
                margin-right: 6px;
                border-radius: 8px;
                border: 1px solid #ddd;
                background: #fff;
                cursor: pointer;
                font-size: 12px;
            }
            .popup-actions a.primary,
            .popup-actions button.primary {
                background: var(--brand);
                color: #fff;
                border-color: var(--brand);
            }
            .note-box {
                width: 100%;
                min-height: 64px;
                padding: 6px;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 13px;
            }
            .corner-btn {
                position: fixed;
                left: 10px;
                bottom: 10px;
                z-index: 1000;
                background: #111;
                color: #fff;
                border: none;
                border-radius: 10px;
                padding: 10px 12px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
                cursor: pointer;
            }
            .locate-btn {
                position: fixed;
                right: 10px;
                top: 10px;
                z-index: 1000;
                background: var(--brand);
                color: #fff;
                border: none;
                border-radius: 10px;
                padding: 10px 12px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
                cursor: pointer;
            }
            .list-btn {
                position: fixed;
                right: 10px;
                bottom: 10px;
                z-index: 1000;
                background: #fff;
                color: #111;
                border: 1px solid #ddd;
                border-radius: 10px;
                padding: 8px 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                cursor: pointer;
            }
            .drawer {
                position: fixed;
                right: 10px;
                bottom: 60px;
                z-index: 1000;
                max-height: 45vh;
                width: 280px;
                overflow: auto;
                background: #fff;
                border: 1px solid #eee;
                border-radius: 10px;
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
                padding: 8px;
                display: none;
            }
            .drawer h4 {
                margin: 6px 6px 8px;
                font-size: 14px;
            }
            .drawer ol {
                margin: 6px 16px;
            }
            .drawer li {
                font-size: 13px;
                margin-bottom: 6px;
            }
            .fullscreen-number {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                z-index: 10000;
                justify-content: center;
                align-items: center;
                flex-direction: column;
            }
            .fullscreen-number.show {
                display: flex;
            }
            .fullscreen-number .big-number {
                color: #fff;
                font-size: 180px;
                font-weight: 700;
                line-height: 1;
            }
            .fullscreen-number .close-btn {
                position: absolute;
                top: 20px;
                right: 20px;
                background: rgba(255, 255, 255, 0.2);
                color: #fff;
                border: none;
                border-radius: 50%;
                width: 44px;
                height: 44px;
                font-size: 24px;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>

        <!-- È°ØÁ§∫Á∏ΩË∑ùÈõ¢ËàáÈªûÊï∏ -->
        <div class="meta-bar">
            <div><strong>Â∞ºÂÖãÊúùËÅñ‰πãË∑Ø</strong></div>
            <div id="dist">Ë®àÁÆó‰∏≠‚Ä¶</div>
            <div id="countInfo" class="legend"></div>
            <div class="legend">Â∏ÉÊãâÊ†º50ÊïôÂ†Ç</div>
        </div>

        <!-- ‰∏ãËºâ CSV -->
        <button class="corner-btn" id="downloadCsvBtn">‚¨áÔ∏è ‰∏ãËºâÁ≠ÜË®ò CSV</button>
        <!-- ÂÆö‰Ωç -->
        <button class="locate-btn" id="locateBtn">üìç ÊàëÁöÑÂÆö‰Ωç</button>
        <!-- Ê∏ÖÂñÆÊäΩÂ±ú -->
        <button class="list-btn" id="listBtn">üóÇ Ê∏ÖÂñÆ</button>
        <div class="drawer" id="drawer">
            <h4>Ë∑ØÁ∑öÈ†ÜÂ∫è</h4>
            <ol id="list"></ol>
        </div>

        <!-- ÂÖ®Â±èÊï∏Â≠óÈ°ØÁ§∫ -->
        <div class="fullscreen-number" id="fullscreenNumber">
            <button
                class="close-btn"
                onclick="document.getElementById('fullscreenNumber').classList.remove('show')"
            >
                √ó
            </button>
            <div class="big-number" id="bigNumber">01</div>
        </div>

        <script
            src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""
        ></script>
        <script>
            /* ====== PWAÔºömanifest & service workerÔºàÈõ¢Á∑öÂèØÁî®Ôºâ ====== */
            (function () {
                const manifest = {
                    name: "Prague Pilgrim Route",
                    short_name: "Pilgrim",
                    start_url: ".",
                    display: "standalone",
                    background_color: "#ffffff",
                    theme_color: "#0A84FF",
                    icons: [],
                };
                const blob = new Blob([JSON.stringify(manifest)], {
                    type: "application/manifest+json",
                });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("link");
                link.rel = "manifest";
                link.href = url;
                document.head.appendChild(link);

                const swCode = `
    const STATIC_CACHE = 'pp-v3';
    const STATIC_ASSETS = [
      './', './index.html',
      'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
      'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'
    ];
    self.addEventListener('install', e=>{
      e.waitUntil(caches.open(STATIC_CACHE).then(c=>c.addAll(STATIC_ASSETS)).then(()=>self.skipWaiting()));
    });
    self.addEventListener('activate', e=>{
      e.waitUntil(
        caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==STATIC_CACHE).map(k=>caches.delete(k))))
      );
    });
    // tiles: runtime cacheÔºàÂèØÈõ¢Á∑öÈáçÁúãÂ∑≤Á∂ìËµ∞ÈÅéÁöÑÂúñÂ°äÔºâ
    self.addEventListener('fetch', e=>{
      const req = e.request; const url = new URL(req.url);
      if (url.hostname.endsWith('cartocdn.com') || url.hostname.endsWith('openstreetmap.org')) {
        e.respondWith(caches.open('tiles-v3').then(async cache=>{
          const cached = await cache.match(req);
          if (cached) return cached;
          try { const fresh = await fetch(req, {mode:'cors'}); cache.put(req, fresh.clone()); return fresh; }
          catch (err) { return cached || Response.error(); }
        }));
        return;
      }
      e.respondWith(caches.match(req).then(cached=>cached || fetch(req)));
    });
  `;
                const swBlob = new Blob([swCode], { type: "text/javascript" });
                const swUrl = URL.createObjectURL(swBlob);
                if ("serviceWorker" in navigator)
                    navigator.serviceWorker.register(swUrl);
            })();

            /* ====== 50 Â∫ßÊ∏ÖÂñÆÔºàÁßªÈô§Êú®ÊïôÂ†ÇÔºõÂä†ÂÖ• Agnes ‰øÆÈÅìÈô¢Ôºâ ======
   ‚úÖ ‰∏¶Êñ∞Â¢û„ÄåËÅñÊñπÊøüÂêÑÊïôÂ†ÇÔºàÁ¥ÖÊòüÂçÅÂ≠óÈ®éÂ£´ÂúòÔºâ„Äç‰ΩúÁÇ∫Á¨¨ 49 Èªû‰æÜÊ∫êÔºåÁ¢∫‰øùÁ∏ΩÊï∏ 50„ÄÇ */
            const PLACES = [
                // Castle area
                {
                    en: "St. Vitus Cathedral",
                    zh: "ËÅñÁ∂≠Áâπ‰∏ªÊïôÂ∫ßÂ†Ç",
                    desc: "Êç∑ÂÖãÊúÄÈáçË¶ÅÁöÑÂì•Âæ∑ÂºèÊïôÂ†ÇÔºåÊ≠∑‰ª£ÂúãÁéãÂä†ÂÜïËàáÂÆâËë¨‰πãÂú∞„ÄÇ",
                    lat: 50.0909,
                    lon: 14.4006,
                },
                {
                    en: "St. George's Basilica",
                    zh: "ËÅñÂñ¨Ê≤ªËÅñÊÆø",
                    desc: "ÂÆåÊï¥ÁæÖÈ¶¨Âºè‰ª£Ë°®ÔºåÂÖßÊúâËÅñÂ•≥Èú≤Âæ∑Á±≥ÊãâÂ¢ì„ÄÇ",
                    lat: 50.0905,
                    lon: 14.402,
                },
                {
                    en: "All Saints Church (Kapituln√≠ kostel V≈°ech svat√Ωch)",
                    zh: "Ë´∏ËÅñÂ†Ç",
                    desc: "ÂüéÂ†°ÊóÅÁöáÂÆ§Á¶ÆÊãúÁ©∫Èñì„ÄÇ",
                    lat: 50.0902,
                    lon: 14.404,
                },
                {
                    en: "Church of St. Benedict",
                    zh: "ËÅñÊú¨ÁØ§ÊïôÂ†Ç",
                    desc: "17‰∏ñÁ¥ÄÂ∑¥Ê¥õÂÖãÂ∞èÂ†Ç„ÄÇ",
                    lat: 50.0912,
                    lon: 14.4058,
                },
                {
                    en: "Loreta",
                    zh: "Ê¥õÈõ∑Â°î",
                    desc: "Â∑¥Ê¥õÂÖãÊúùËÅñÂú∞ÔºåËÅñÂ±ãËàáÂ†±ÊôÇÈäÄÈêò„ÄÇ",
                    lat: 50.0885,
                    lon: 14.3893,
                },
                {
                    en: "Strahov Monastery ‚Äì Basilica of the Assumption",
                    zh: "ÊñØÁâπÊãâÈúçÂ§´‰øÆÈÅìÈô¢ËÅñÊØçÂçáÂ§©Â§ßÊÆø",
                    desc: "12‰∏ñÁ¥Ä‰øÆÈÅìÈô¢ÔºåÂúñÊõ∏È§®ËàáËóùË°ìËóèÂìÅË±êÂØå„ÄÇ",
                    lat: 50.0863,
                    lon: 14.3913,
                },
                {
                    en: "St. Nicholas (Mal√° Strana)",
                    zh: "Â∞èÂüéÂçÄËÅñÂ∞ºÂè§Êãâ",
                    desc: "Â∑¥Ê¥õÂÖãÂúìÈ†ÇËàáÂ£ØÈ∫óÁÆ°È¢®Áê¥„ÄÇ",
                    lat: 50.088,
                    lon: 14.4043,
                },
                {
                    en: "Our Lady Victorious & Infant Jesus of Prague",
                    zh: "ÂãùÂà©ËÅñÊØçËàáÂ∏ÉÊãâÊ†ºËÅñÂ¨∞",
                    desc: "ÂúãÈöõÊúùËÅñÂú∞„ÄÇ",
                    lat: 50.0851,
                    lon: 14.4047,
                },
                {
                    en: "St. Thomas Church (Augustinian)",
                    zh: "ËÅñÂ§öÁë™ÊïôÂ†ÇÔºàÂ•ßÂè§ÊñØ‰∏ÅÊúÉÔºâ",
                    desc: "‰øÆÊúÉÊïôÂ†ÇÔºåËóùË°ìË£ùÈ£æËèØÈ∫ó„ÄÇ",
                    lat: 50.087,
                    lon: 14.4048,
                },
                {
                    en: "Our Lady beneath the Chain",
                    zh: "Èèà‰∏ãËÅñÊØçÊïôÂ†Ç",
                    desc: "È¶¨ËÄ≥‰ªñÈ®éÂ£´ÂúòÂè§ÊïôÂ†Ç„ÄÇ",
                    lat: 50.0868,
                    lon: 14.4059,
                },
                {
                    en: "St. Mary Magdalene (Orthodox)",
                    zh: "ËÅñÁë™Âà©‰∫ûÁë™ÈÅîËÇãÁ¥çÔºàÊù±Ê≠£ÊïôÔºâ",
                    desc: "Êù±Ê≠£ÊïôÊú®Ê¥ãËî•Â°îÈ¢®Ê†º„ÄÇ",
                    lat: 50.0876,
                    lon: 14.4095,
                },

                // Old Town core
                {
                    en: "Old Town St. Nicholas (Hussite)",
                    zh: "ËàäÂüéËÅñÂ∞ºÂè§ÊãâÔºàËÉ°ÊñØÊ¥æÔºâ",
                    desc: "ËàäÂüéÂª£Â†¥ÂåóÂÅ¥Âú∞Ê®ô„ÄÇ",
                    lat: 50.0877,
                    lon: 14.4206,
                },
                {
                    en: "Church of Our Lady before T√Ωn",
                    zh: "Ê≥∞ÊÅ©ËÅñÊØçÊïôÂ†Ç",
                    desc: "ÈõôÂ°îÂì•Âæ∑Âú∞Ê®ô„ÄÇ",
                    lat: 50.0872,
                    lon: 14.4213,
                },
                {
                    en: "Basilica of St. James the Greater",
                    zh: "Â§ßËÅñÈõÖÂêÑ‰ºØËÅñÊÆø",
                    desc: "Â∑¥Ê¥õÂÖãÂÖßÈ£æËàá„ÄéÊñ∑ÊâãÂÇ≥Ë™™„Äè„ÄÇ",
                    lat: 50.0879,
                    lon: 14.4275,
                },
                {
                    en: "Church of St. Havel / St. Gall",
                    zh: "ËÅñÂä†‰æñÊïôÂ†Ç",
                    desc: "‰∏≠‰∏ñÁ¥ÄÂüéÂ∏ÇÊïôÂ†Ç„ÄÇ",
                    lat: 50.0846,
                    lon: 14.4222,
                },
                {
                    en: "Church of St. Giles",
                    zh: "ËÅñÂêâÊãâÊñØÊïôÂ†Ç",
                    desc: "Âì•Âæ∑√óÂ∑¥Ê¥õÂÖãËûçÂêàÔºõÁÆ°È¢®Áê¥ËëóÂêç„ÄÇ",
                    lat: 50.0859,
                    lon: 14.4209,
                },
                {
                    en: "Kostel sv. Martina ve zdi",
                    zh: "ÁâÜ‰∏≠ËÅñÈ¶¨‰∏Å",
                    desc: "Êó©ÊúüÂì•Âæ∑Â∞èÂ†Ç„ÄÇ",
                    lat: 50.0848,
                    lon: 14.4219,
                },
                {
                    en: "Kostel U Salv√°tora (Reformed)",
                    zh: "Êïë‰∏ªÊñ∞ÊïôÊïôÂ†Ç",
                    desc: "ÊîπÈù©ÂÆóÈáçÈéÆ„ÄÇ",
                    lat: 50.0887,
                    lon: 14.4264,
                },
                {
                    en: "Church of the Holy Spirit",
                    zh: "ËÅñÁ•ûÊïôÂ†Ç",
                    desc: "ÂâçÂ§öÊòéÊàëÂ•≥‰øÆÈô¢ÈÅ∫ÂùÄ„ÄÇ",
                    lat: 50.0895,
                    lon: 14.4207,
                },
                {
                    en: "Armenian Apostolic Church",
                    zh: "‰∫ûÁæéÂ∞º‰∫ûÂÆóÂæíÊïôÊúÉ",
                    desc: "ÊóèÁæ§Ëàá‰ø°‰ª∞Â§öÂÖÉ„ÄÇ",
                    lat: 50.0917,
                    lon: 14.4271,
                },
                {
                    en: "Bethlehem Chapel",
                    zh: "‰ºØÂà©ÊÅÜÁ¶ÆÊãúÂ†Ç",
                    desc: "ËÉ°ÊñØË¨õÈÅìÂú∞ÔºåÂÆóÊîπË±°Âæµ„ÄÇ",
                    lat: 50.0846,
                    lon: 14.4179,
                },
                {
                    en: "St. Salvator (Klementinum, Jesuit)",
                    zh: "ÂÖãËêäÈñÄÁâπÂ≠∏Èô¢ËÅñÊïë‰∏ñ‰∏ª",
                    desc: "ËÄ∂Á©åÊúÉ‰∏ªÊïôÂ†Ç„ÄÇ",
                    lat: 50.0865,
                    lon: 14.4148,
                },
                {
                    en: "Church of St. Francis of Assisi (Knights of the Cross)",
                    zh: "ËÅñÊñπÊøüÂêÑÊïôÂ†ÇÔºàÁ¥ÖÊòüÂçÅÂ≠óÈ®éÂ£´ÂúòÔºâ",
                    desc: "Êü•ÁêÜÂ§ßÊ©ãËàäÂüéÁ´ØÁöÑÂúìÈ†ÇÊïôÂ†Ç„ÄÇ",
                    lat: 50.0869,
                    lon: 14.4119,
                },
                {
                    en: "St. Clement (Byzantine Rite Cathedral)",
                    zh: "ËÅñÂÖãËêäÂ≠üÔºàÊù±ÂÑÄ‰∏ªÊïôÂ∫ßÔºâ",
                    desc: "ÁÉèÂÖãËò≠Êù±ÂÑÄ‰∏ªÊïôÂ∫ßÂ†Ç„ÄÇ",
                    lat: 50.086,
                    lon: 14.4156,
                },

                // New Town
                {
                    en: "Church of Our Lady of the Snows",
                    zh: "Èõ™‰πãËÅñÊØçÊïôÂ†Ç",
                    desc: "ÂéüË®àÁï´ÂÖ®ÂüéÊúÄÂ§ß„ÄÇ",
                    lat: 50.0812,
                    lon: 14.4243,
                },
                {
                    en: "St. Ignatius of Loyola",
                    zh: "‰æùÁ¥çÁàµÁæÖËÄÄÊãâÊïôÂ†Ç",
                    desc: "ËÄ∂Á©åÊúÉÂú∞Ê®ôÔºåÈÄèË¶ñÂ§©È†ÇÁï´„ÄÇ",
                    lat: 50.0756,
                    lon: 14.4219,
                },
                {
                    en: "Church of St. Stephen (sv. ≈†tƒõp√°n)",
                    zh: "ËÅñÊñØÂæ∑ÊúõÊïôÂ†Ç",
                    desc: "14‰∏ñÁ¥ÄÊñ∞ÂüéÊó©ÊúüÔºåÂ°îÊôØ‰Ω≥„ÄÇ",
                    lat: 50.0755,
                    lon: 14.4292,
                },
                {
                    en: "Church of St. Henry & St. Cunigunde",
                    zh: "ËÅñ‰∫®Âà©ËàáËÅñÊòÜÂ∞ºË≤¢Âæ∑",
                    desc: "Âì•Âæ∑Â°îËàáÁöáÊ¨äË±°Âæµ„ÄÇ",
                    lat: 50.0824,
                    lon: 14.4317,
                },
                {
                    en: "Holy Cross Church",
                    zh: "ËÅñÂçÅÂ≠óÊïôÂ†Ç",
                    desc: "ÈÜ´Èô¢ÊïôÂ†ÇÔºåÂ£ÅÁï´‰Ω≥„ÄÇ",
                    lat: 50.084,
                    lon: 14.4278,
                },
                {
                    en: "Church of St. Joseph (Capuchin)",
                    zh: "ËÅñËã•ÁëüÔºàÂòâÂ∏ÉÈÅ£ÊúÉÔºâ",
                    desc: "‰øÆÊúÉÁ∞°Ê®∏‰πãÁæé„ÄÇ",
                    lat: 50.0846,
                    lon: 14.4297,
                },
                {
                    en: "Jan Hus Chapel",
                    zh: "ÊèöËÉ°ÊñØÁ¶ÆÊãúÂ†Ç",
                    desc: "Áèæ‰ª£Á¥ÄÂøµÂª∫ÁØâ„ÄÇ",
                    lat: 50.0817,
                    lon: 14.423,
                },
                {
                    en: "Church of St. Apollinaire",
                    zh: "ËÅñÈòøÁéªÈáåÁ¥çÊïôÂ†Ç",
                    desc: "14‰∏ñÁ¥ÄÂì•Âæ∑ÔºåÂÖßÊúâÂ£ÅÁï´„ÄÇ",
                    lat: 50.0712,
                    lon: 14.4325,
                },
                {
                    en: "Church of St. Katherine of Alexandria",
                    zh: "ËÅñÂá±ÁëüÁê≥ÊïôÂ†Ç",
                    desc: "Á≤âËâ≤Â§ñÁâÜËàáÂÑ™ÈõÖÂÖßÈ£æ„ÄÇ",
                    lat: 50.0705,
                    lon: 14.4291,
                },
                {
                    en: "St. Vor≈°ily (Ursulines)",
                    zh: "ËÅñÁÉèÁàæËòáÊãâÊïôÂ†Ç",
                    desc: "Â•≥Â≠êÊïôËÇ≤‰øÆÊúÉÊìöÈªû„ÄÇ",
                    lat: 50.0774,
                    lon: 14.4175,
                },
                {
                    en: "Kostel sv. V√°clava na Zderaze",
                    zh: "Ëå≤Âæ∑ÊãâÊæ§ÁöÑËÅñÊ∫´Â°ûÊñØÊãâÊñØ",
                    desc: "ËÉ°ÊñØÊ¥æÈáçË¶ÅÈÅ∫Ë∑°„ÄÇ",
                    lat: 50.0765,
                    lon: 14.4187,
                },
                {
                    en: "Ss. Cyril and Methodius Cathedral (New Town)",
                    zh: "ËÅñË•øÈáåÁàæËàáÊ¢ÖÊâòÁãÑÁÉèÊñØ‰∏ªÊïôÂ∫ßÂ†Ç",
                    desc: "‰∫åÊà∞ÊäµÊäóËÅñÂú∞„ÄÇ",
                    lat: 50.0737,
                    lon: 14.4185,
                },

                // Vy≈°ehrad
                {
                    en: "Basilica of Sts. Peter & Paul (Vy≈°ehrad)",
                    zh: "Á∂≠Ë¨ùËµ´ÊãâÂæ∑ËÅñ‰ºØÂ§öÁ•øËàá‰øùÁ•øÂ§ßÊÆø",
                    desc: "ÈõôÂ°îÂú∞Ê®ôÔºåÈÑ∞ÂúãÂÆ∂ÂÖ¨Â¢ì„ÄÇ",
                    lat: 50.0653,
                    lon: 14.4198,
                },
                {
                    en: "Rotunda sv. Martina (Vy≈°ehrad)",
                    zh: "ËÅñÈ¶¨‰∏ÅÂúìÂΩ¢Â†ÇÔºàÁ∂≠Ë¨ùËµ´ÊãâÂæ∑Ôºâ",
                    desc: "11‰∏ñÁ¥ÄÁü≥Á†åÂúìÂ†Ç„ÄÇ",
                    lat: 50.0645,
                    lon: 14.4179,
                },
                {
                    en: "Church of the Holy Trinity (Vy≈°ehrad area)",
                    zh: "ËÅñ‰∏âÊïôÂ†ÇÔºàÁ∂≠Ë¨ùËµ´ÊãâÂæ∑ÂçÄÔºâ",
                    desc: "È´òÂú∞Â∞èÂûãÈùú‰øÆÈªû„ÄÇ",
                    lat: 50.0641,
                    lon: 14.4206,
                },

                // Karl√≠n / ≈Ωi≈ækov / Vinohrady
                {
                    en: "Ss. Cyril and Methodius (Karl√≠n)",
                    zh: "ËÅñË•øÈáåÁàæËàáÊ¢ÖÊâòÁãÑÁÉèÊñØÔºàÂç°ÊûóÔºâ",
                    desc: "19‰∏ñÁ¥ÄÊñ∞ÁæÖÈ¶¨ÂºèÂ∑®Êßã„ÄÇ",
                    lat: 50.0918,
                    lon: 14.4488,
                },
                {
                    en: "Basilica of St. Ludmila (Vinohrady)",
                    zh: "ËÅñÈú≤Âæ∑Á±≥ÊãâÂ§ßÊÆøÔºàÁ∂≠Ë´æËµ´ÊãâËø™Ôºâ",
                    desc: "Êñ∞Âì•Âæ∑ÈõôÂ°î„ÄÇ",
                    lat: 50.0755,
                    lon: 14.4399,
                },
                {
                    en: "Sacred Heart (Kostel Nejsvƒõtƒõj≈°√≠ho Srdce P√°nƒõ)",
                    zh: "ËÄ∂Á©åËÅñÂøÉÊïôÂ†ÇÔºàÁ∂≠Ë´æËµ´ÊãâËø™Ôºâ",
                    desc: "Pleƒçnik ÂÇë‰Ωú„ÄÇ",
                    lat: 50.0793,
                    lon: 14.4506,
                },
                {
                    en: "Church of St. Procopius (≈Ωi≈ækov)",
                    zh: "ËÅñÊôÆÁæÖÁßëÊØîÊïôÂ†ÇÔºàÊó•Êó•ÁßëÂ§´Ôºâ",
                    desc: "Êñ∞Âì•Âæ∑ÔºåÂ∑•‰∫∫ÂçÄË±°Âæµ„ÄÇ",
                    lat: 50.0834,
                    lon: 14.453,
                },
                {
                    en: "Church of St. Peter at Po≈ô√≠ƒç√≠",
                    zh: "ÊôÆÁÜ±Â•áÁöÑËÅñ‰ºØÂ§öÁ•øÊïôÂ†Ç",
                    desc: "ÁæÖÈ¶¨ÂºèÊ†∏ÂøÉÂè§Â†Ç„ÄÇ",
                    lat: 50.0915,
                    lon: 14.4366,
                },

                // Medieval small / Others
                {
                    en: "Rotunda of the Holy Cross (Men≈°√≠)",
                    zh: "Â∞èËÅñÂçÅÂ≠óÂúìÂΩ¢Â†Ç",
                    desc: "12‰∏ñÁ¥ÄÂÉÖÂ≠òÂúìÂ†Ç„ÄÇ",
                    lat: 50.0876,
                    lon: 14.4228,
                },
                {
                    en: "Rotunda of St. Longinus",
                    zh: "ËÅñÈöÜÂü∫Âä™ÊñØÂúìÂΩ¢Â†Ç",
                    desc: "Êó©ÊúüÂúìÂ†ÇÔºåÊØî‰æãÁ¥îÁ≤π„ÄÇ",
                    lat: 50.0736,
                    lon: 14.4272,
                },
                {
                    en: "Emmaus Monastery ‚Äì Our Lady & St. Charles the Great",
                    zh: "ËâæÁë™ÁÉèÊñØ‰øÆÈÅìÈô¢",
                    desc: "ÊñØÊãâÂ§´Á¶ÆÂÇ≥Áµ±ÔºåÁèæ‰ª£Â±ãÈ†Ç„ÄÇ",
                    lat: 50.0739,
                    lon: 14.4156,
                },
                {
                    en: "St. John of Nepomuk na Skalce",
                    zh: "Â≤©‰∏äËÅñËã•Êúõ¬∑Á¥çÊ≥¢Á©ÜÂÖã",
                    desc: "ÊÆâÈÅì‰∏ªÈ°åÂ∑¥Ê¥õÂÖã„ÄÇ",
                    lat: 50.0751,
                    lon: 14.4144,
                },
                {
                    en: "St. Clement's (Klementinum complex)",
                    zh: "ÂÖãËêäÈñÄÁâπÂ≠∏Èô¢ËÅñÂÖãËêäÂ≠ü",
                    desc: "ËÄ∂Á©åÊúÉÂ≠∏Èô¢Áæ§‰∏ÄÈÉ®ÂàÜ„ÄÇ",
                    lat: 50.0861,
                    lon: 14.4152,
                },

                // Agnes MonasteryÔºàÁ¨¨ 50Ôºâ
                {
                    en: "St. Agnes Monastery ‚Äì Church of St. Francis & St. Salvator",
                    zh: "ËÅñËâæÊ†ºÂ∞ºÁµ≤‰øÆÈÅìÈô¢ÔºàÊñπÊøüËàáÊïë‰∏ñ‰∏ªÔºâ",
                    desc: "‰∏≠‰∏ñÁ¥ÄÂ•≥‰øÆÈô¢ÈÅ∫ÂùÄÔºåÂúãÂÆ∂ÁæéË°ìÈ§®ÂàÜÈ§®„ÄÇ",
                    lat: 50.0925,
                    lon: 14.4292,
                },
            ];

            // È°ØÁ§∫Á≠ÜÊï∏ÔºàÂøÖÈ†à 50Ôºâ
            const countInfo = document.getElementById("countInfo");
            countInfo.textContent = `Loaded places: ${PLACES.length} / 50`;
            if (PLACES.length !== 50)
                alert(`ÁõÆÂâçËºâÂÖ• ${PLACES.length} Á≠ÜÔºåÊáâÁÇ∫ 50„ÄÇË´ãÊ™¢Êü•Ê∏ÖÂñÆ„ÄÇ`);

            /* ====== Ë∑ùÈõ¢ & Ëøë‰ººÊúÄÁü≠Ë∑ØÂæëÔºàNN + 2-optÔºâ ====== */
            const toRad = (d) => (d * Math.PI) / 180;
            function haversine(lat1, lon1, lat2, lon2) {
                const R = 6371000;
                const dphi = toRad(lat2 - lat1),
                    dlmb = toRad(lon2 - lon1);
                const a =
                    Math.sin(dphi / 2) ** 2 +
                    Math.cos(toRad(lat1)) *
                        Math.cos(toRad(lat2)) *
                        Math.sin(dlmb / 2) ** 2;
                return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            }
            function nearestNeighbor(points, startIdx = 0) {
                const unvisited = new Set(points.map((_, i) => i));
                const route = [startIdx];
                unvisited.delete(startIdx);
                while (unvisited.size) {
                    const last = route[route.length - 1];
                    let best = null,
                        bestD = Infinity;
                    for (const j of unvisited) {
                        const d = haversine(
                            points[last].lat,
                            points[last].lon,
                            points[j].lat,
                            points[j].lon,
                        );
                        if (d < bestD) {
                            bestD = d;
                            best = j;
                        }
                    }
                    route.push(best);
                    unvisited.delete(best);
                }
                return route;
            }
            function twoOpt(route, pts, maxIter = 220) {
                function seg(a, b) {
                    return haversine(
                        pts[a].lat,
                        pts[a].lon,
                        pts[b].lat,
                        pts[b].lon,
                    );
                }
                let improved = true,
                    iter = 0;
                while (improved && iter < maxIter) {
                    improved = false;
                    iter++;
                    for (let i = 0; i < route.length - 2; i++) {
                        for (let j = i + 2; j < route.length - 1; j++) {
                            const A = route[i],
                                B = route[i + 1],
                                C = route[j],
                                D = route[j + 1];
                            const curr = seg(A, B) + seg(C, D);
                            const swap = seg(A, C) + seg(B, D);
                            if (swap + 1e-7 < curr) {
                                const slice = route
                                    .slice(i + 1, j + 1)
                                    .reverse();
                                route.splice(i + 1, j - i, ...slice);
                                improved = true;
                            }
                        }
                    }
                }
                return route;
            }
            function totalDistance(route, pts) {
                let s = 0;
                for (let i = 0; i < route.length - 1; i++) {
                    const A = pts[route[i]],
                        B = pts[route[i + 1]];
                    s += haversine(A.lat, A.lon, B.lat, B.lon);
                }
                return s;
            }

            // Ëµ∑ÈªûÔºöÊ≥∞ÊÅ©ËÅñÊØçÔºàÊâæ‰∏çÂà∞Â∞± 0Ôºâ
            const startIndex = PLACES.findIndex((p) =>
                /Our Lady before T√Ωn/i.test(p.en),
            );
            const nn = nearestNeighbor(
                PLACES,
                startIndex >= 0 ? startIndex : 0,
            );
            const order = twoOpt(nn.slice(), PLACES);

            /* ====== LeafletÔºöCarto Positron Ê•µÁ∞°Â∫ïÂúñ ====== */
            const map = L.map("map", { zoomControl: true });
            L.tileLayer(
                "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
                {
                    maxZoom: 19,
                    attribution: "&copy; OpenStreetMap &copy; CARTO",
                },
            ).addTo(map);

            function numberedIcon(n) {
                return L.divIcon({
                    className: "num-marker",
                    html: String(n).padStart(2, "0"),
                    iconSize: [28, 28],
                    iconAnchor: [14, 14],
                });
            }

            /* ====== Google Maps ÈÄ£ÁµêÔºàÂêçÁ®±ÊêúÂ∞ãÂÑ™ÂÖà + Â∫ßÊ®ôÂÇôÊè¥Ôºâ & Á≠ÜË®ò ====== */
            function gmapsByName(p) {
                const q = encodeURIComponent(`${p.en}, Prague, Czechia`);
                return `https://www.google.com/maps/search/?api=1&query=${q}`;
            }
            function gmapsByCoord(p) {
                return `https://www.google.com/maps?q=${p.lat},${p.lon}`;
            }
            function noteKey(p) {
                return `pp_note_${p.lat.toFixed(6)}_${p.lon.toFixed(6)}`;
            }
            function getNote(p) {
                return localStorage.getItem(noteKey(p)) || "";
            }

            // Áπ™Ë£ΩÈªûËàáË∑ØÂæë
            const latlngs = [];
            const list = document.getElementById("list");
            const markersData = []; // ÂÑ≤Â≠òÊ®ôË®òË≥áË®ä‰ª•‰æøÁ®çÂæåÊõ¥Êñ∞

            order.forEach((idx, i) => {
                const p = PLACES[idx];
                latlngs.push([p.lat, p.lon]);
                const title = `${String(i + 1).padStart(2, "0")}. ${p.en}Ôºà${p.zh}Ôºâ`;
                const id = noteKey(p);
                const seqNum = i + 1;

                markersData.push({ p, id, seqNum, title });

                // ÂâµÂª∫ÂáΩÊï∏‰æÜÁîüÊàê popup ÂÖßÂÆπÔºåÊØèÊ¨°ÊâìÈñãÊôÇÈÉΩÊúÉÈáçÊñ∞ËÆÄÂèñ localStorage
                function getPopupContent() {
                    const currentNote = getNote(p);
                    return `
    <h3>${title}</h3>
    <p>${p.desc}</p>
    <div class="popup-actions">
      <a class="primary" href="${gmapsByName(p)}" target="_blank" rel="noopener">Áî®ÂêçÁ®±ÈñãÂïü Google Maps</a>
      <a href="${gmapsByCoord(p)}" target="_blank" rel="noopener">Áî®Â∫ßÊ®ôÈñãÂïü</a>
      <button onclick="showFullscreenNumber(${seqNum})">üî¢ È°ØÁ§∫ËôüÁ¢º</button>
    </div>
    <div style="margin-top:8px;">
      <textarea class="note-box" id="${id}" placeholder="Âú®Ê≠§Ëº∏ÂÖ•Á≠ÜË®òÔºàÂÉÖÂÑ≤Â≠òÂú®Êú¨Ê©üÔºâ">${currentNote}</textarea>
      <div class="popup-actions" style="margin-top:6px;">
        <button class="primary" onclick="saveNote('${id}')">üíæ ÂÑ≤Â≠òÁ≠ÜË®ò</button>
      </div>
    </div>`;
                }

                const m = L.marker([p.lat, p.lon], {
                    icon: numberedIcon(seqNum),
                    title,
                });

                // ‰ΩøÁî® Leaflet ÁöÑ popup ‰∫ã‰ª∂ÔºåÂú®ÊØèÊ¨°ÊâìÈñãÊôÇÊõ¥Êñ∞ÂÖßÂÆπ
                const popup = L.popup({ maxWidth: 320 });
                m.bindPopup(popup);

                m.on("click", function () {
                    popup.setContent(getPopupContent());
                });

                m.addTo(map);

                // Ê∏ÖÂñÆÂàóÂá∫ÔºàÂèØÈªûÔºâ
                const li = document.createElement("li");
                li.innerHTML = `<a href="#" onclick="return false;">${title}</a>`;
                li.addEventListener("click", () => {
                    popup.setContent(getPopupContent());
                    m.openPopup();
                    map.panTo([p.lat, p.lon]);
                });
                list.appendChild(li);
            });

            // Ë∑ØÂæë & Ë¶ñÁ™ó
            const poly = L.polyline(latlngs, {
                color: "#0A84FF",
                weight: 4,
                opacity: 0.85,
            }).addTo(map);
            map.fitBounds(poly.getBounds(), { padding: [28, 28] });

            // Á∏ΩË∑ùÈõ¢
            const distKm = (totalDistance(order, PLACES) / 1000).toFixed(1);
            document.getElementById("dist").textContent =
                `Total route ‚âà ${distKm} km | Points: ${order.length}`;

            // Ê∏ÖÂñÆÊäΩÂ±ú toggle
            const drawer = document.getElementById("drawer");
            document.getElementById("listBtn").addEventListener("click", () => {
                drawer.style.display =
                    drawer.style.display === "block" ? "none" : "block";
            });

            /* ====== CSV ‰∏ãËºâÔºö50 Â∫ßÔºãÁ≠ÜË®ò ====== */
            function downloadCSV() {
                const header = [
                    "Index",
                    "English",
                    "Chinese",
                    "Description",
                    "Lat",
                    "Lon",
                    "Note",
                ];
                const rows = order.map((idx, i) => {
                    const p = PLACES[idx];
                    const note = (getNote(p) || "").replace(/\r?\n/g, " ");
                    return [i + 1, p.en, p.zh, p.desc, p.lat, p.lon, note];
                });
                const csv = [header, ...rows]
                    .map((r) =>
                        r
                            .map((v) => {
                                const s = String(v ?? "");
                                return /[",\n]/.test(s)
                                    ? `"${s.replace(/"/g, '""')}"`
                                    : s;
                            })
                            .join(","),
                    )
                    .join("\n");
                const blob = new Blob([csv], {
                    type: "text/csv;charset=utf-8;",
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "Prague_Pilgrim_Notes.csv";
                a.click();
                URL.revokeObjectURL(url);
            }
            document
                .getElementById("downloadCsvBtn")
                .addEventListener("click", downloadCSV);

            /* ====== ‰ΩøÁî®ËÄÖÂÆö‰Ωç ====== */
            let userMarker, userCircle;
            document
                .getElementById("locateBtn")
                .addEventListener("click", () => {
                    // Ë´ãÊ±ÇÂÆö‰ΩçÊ¨äÈôê‰∏¶Ë®≠ÂÆöË¶ñÂúñ
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const lat = position.coords.latitude;
                                const lon = position.coords.longitude;
                                const accuracy = position.coords.accuracy;

                                if (userMarker) {
                                    map.removeLayer(userMarker);
                                    map.removeLayer(userCircle);
                                }

                                userMarker = L.marker([lat, lon], {
                                    title: "Your Location",
                                }).addTo(map);

                                userCircle = L.circle([lat, lon], {
                                    radius: accuracy,
                                    color: "#34c759",
                                }).addTo(map);

                                map.setView([lat, lon], 16);
                            },
                            (error) => {
                                let msg = "ÂÆö‰ΩçÂ§±Êïó";
                                if (error.code === 1)
                                    msg =
                                        "ÂÆö‰ΩçÂ§±ÊïóÔºöË´ãÂú®ÁÄèË¶ΩÂô®Ë®≠ÂÆö‰∏≠ÂÖÅË®±‰ΩçÁΩÆÊ¨äÈôê";
                                else if (error.code === 2)
                                    msg = "ÂÆö‰ΩçÂ§±ÊïóÔºöÁÑ°Ê≥ïÂèñÂæó‰ΩçÁΩÆË≥áË®ä";
                                else if (error.code === 3)
                                    msg = "ÂÆö‰ΩçÂ§±ÊïóÔºöË´ãÊ±ÇÈÄæÊôÇ";
                                alert(msg);
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 0,
                            },
                        );
                    } else {
                        alert("ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ÂÆö‰ΩçÂäüËÉΩ");
                    }
                });

            // ‰øùÁïô Leaflet ÁöÑÂÆö‰Ωç‰∫ã‰ª∂ËôïÁêÜÔºà‰ΩúÁÇ∫ÂÇôÁî®Ôºâ
            map.on("locationfound", (e) => {
                if (userMarker) {
                    map.removeLayer(userMarker);
                    map.removeLayer(userCircle);
                }
                userMarker = L.marker(e.latlng, {
                    title: "Your Location",
                }).addTo(map);
                userCircle = L.circle(e.latlng, {
                    radius: e.accuracy,
                    color: "#34c759",
                }).addTo(map);
                if (!map.getBounds().contains(e.latlng)) map.panTo(e.latlng);
            });
            map.on("locationerror", (e) => alert("ÂÆö‰ΩçÂ§±ÊïóÔºö" + e.message));

            /* ====== ÂÖ®ÂüüÂáΩÊï∏ÔºöÂÑ≤Â≠òÁ≠ÜË®ò & È°ØÁ§∫ÂÖ®Â±èËôüÁ¢º ====== */
            window.saveNote = function (noteId) {
                const textarea = document.getElementById(noteId);
                if (textarea) {
                    const text = textarea.value;
                    localStorage.setItem(noteId, (text || "").trim());
                    alert("Â∑≤ÂÑ≤Â≠òËá≥Êú¨Ê©ü");
                }
            };

            window.showFullscreenNumber = function (num) {
                const display = document.getElementById("fullscreenNumber");
                const numberEl = document.getElementById("bigNumber");
                numberEl.textContent = String(num).padStart(2, "0");
                display.classList.add("show");
            };
        </script>
    </body>
</html>
