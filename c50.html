<!doctype html>
<html lang="zh-Hant">
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width,initial-scale=1,viewport-fit=cover"
        />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-title" content="Prague Pilgrim" />
        <meta name="apple-mobile-web-app-status-bar-style" content="default" />
        <meta name="theme-color" content="#0A84FF" />
        <title>Nickçš„æœè–ä¹‹è·¯-å¸ƒæ‹‰æ ¼50æ•™å ‚</title>
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""
        />
        <style>
            :root {
                --brand: #0a84ff;
            }
            html,
            body {
                height: 100%;
                margin: 0;
                font:
                    14px/1.4 -apple-system,
                    BlinkMacSystemFont,
                    Segoe UI,
                    Arial;
            }
            #map {
                height: 100%;
            }
            .meta-bar {
                position: fixed;
                left: 10px;
                top: 10px;
                z-index: 1000;
                background: rgba(255, 255, 255, 0.92);
                border-radius: 10px;
                padding: 8px 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.12);
            }
            .legend {
                font-size: 12px;
                color: #555;
            }
            .num-marker {
                background: #e63946;
                color: #fff;
                font-weight: 700;
                border: 2px solid #fff;
                border-radius: 16px;
                width: 28px;
                height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 0 6px rgba(0, 0, 0, 0.3);
            }
            .leaflet-popup-content h3 {
                margin: 0 0 6px;
                font-size: 15px;
            }
            .leaflet-popup-content p {
                margin: 0 0 8px;
                font-size: 13px;
            }
            .popup-actions a,
            .popup-actions button {
                display: inline-block;
                padding: 6px 10px;
                margin-right: 6px;
                border-radius: 8px;
                border: 1px solid #ddd;
                background: #fff;
                cursor: pointer;
                font-size: 12px;
            }
            .popup-actions a.primary,
            .popup-actions button.primary {
                background: var(--brand);
                color: #fff;
                border-color: var(--brand);
            }
            .note-box {
                width: 100%;
                min-height: 64px;
                padding: 6px;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 13px;
            }
            .corner-btn {
                position: fixed;
                left: 10px;
                bottom: 10px;
                z-index: 1000;
                background: #111;
                color: #fff;
                border: none;
                border-radius: 10px;
                padding: 10px 12px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
                cursor: pointer;
            }
            .locate-btn {
                position: fixed;
                right: 10px;
                top: 10px;
                z-index: 1000;
                background: var(--brand);
                color: #fff;
                border: none;
                border-radius: 10px;
                padding: 10px 12px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
                cursor: pointer;
            }
            .list-btn {
                position: fixed;
                right: 10px;
                bottom: 10px;
                z-index: 1000;
                background: #fff;
                color: #111;
                border: 1px solid #ddd;
                border-radius: 10px;
                padding: 8px 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                cursor: pointer;
            }
            .drawer {
                position: fixed;
                right: 10px;
                bottom: 60px;
                z-index: 1000;
                max-height: 45vh;
                width: 280px;
                overflow: auto;
                background: #fff;
                border: 1px solid #eee;
                border-radius: 10px;
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
                padding: 8px;
                display: none;
            }
            .drawer h4 {
                margin: 6px 6px 8px;
                font-size: 14px;
            }
            .drawer ol {
                margin: 6px 16px;
            }
            .drawer li {
                font-size: 13px;
                margin-bottom: 6px;
            }
            .fullscreen-number {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                z-index: 10000;
                justify-content: center;
                align-items: center;
                flex-direction: column;
            }
            .fullscreen-number.show {
                display: flex;
            }
            .fullscreen-number .big-number {
                color: #fff;
                font-size: 180px;
                font-weight: 700;
                line-height: 1;
            }
            .fullscreen-number .close-btn {
                position: absolute;
                top: 20px;
                right: 20px;
                background: rgba(255, 255, 255, 0.2);
                color: #fff;
                border: none;
                border-radius: 50%;
                width: 44px;
                height: 44px;
                font-size: 24px;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>

        <!-- é¡¯ç¤ºç¸½è·é›¢èˆ‡é»æ•¸ -->
        <div class="meta-bar">
            <div><strong>å°¼å…‹æœè–ä¹‹è·¯</strong></div>
            <div id="dist">è¨ˆç®—ä¸­â€¦</div>
            <div id="countInfo" class="legend"></div>
            <div class="legend">å¸ƒæ‹‰æ ¼50æ•™å ‚</div>
        </div>

        <!-- ä¸‹è¼‰ CSV -->
        <button class="corner-btn" id="downloadCsvBtn">â¬‡ï¸ ä¸‹è¼‰ç­†è¨˜ CSV</button>
        <!-- å®šä½ -->
        <button class="locate-btn" id="locateBtn">ğŸ“ æˆ‘çš„å®šä½</button>
        <!-- æ¸…å–®æŠ½å±œ -->
        <button class="list-btn" id="listBtn">ğŸ—‚ æ¸…å–®</button>
        <div class="drawer" id="drawer">
            <h4>è·¯ç·šé †åº</h4>
            <ol id="list"></ol>
        </div>

        <!-- å…¨å±æ•¸å­—é¡¯ç¤º -->
        <div class="fullscreen-number" id="fullscreenNumber">
            <button
                class="close-btn"
                onclick="document.getElementById('fullscreenNumber').classList.remove('show')"
            >
                Ã—
            </button>
            <div class="big-number" id="bigNumber">01</div>
        </div>

        <script
            src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""
        ></script>
        <script>
            /* ====== PWAï¼šmanifest & service workerï¼ˆé›¢ç·šå¯ç”¨ï¼‰ ====== */
            (function () {
                const manifest = {
                    name: "Prague Pilgrim Route",
                    short_name: "Pilgrim",
                    start_url: ".",
                    display: "standalone",
                    background_color: "#ffffff",
                    theme_color: "#0A84FF",
                    icons: [],
                };
                const blob = new Blob([JSON.stringify(manifest)], {
                    type: "application/manifest+json",
                });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("link");
                link.rel = "manifest";
                link.href = url;
                document.head.appendChild(link);

                const swCode = `
    const STATIC_CACHE = 'pp-v3';
    const STATIC_ASSETS = [
      './', './index.html',
      'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
      'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'
    ];
    self.addEventListener('install', e=>{
      e.waitUntil(caches.open(STATIC_CACHE).then(c=>c.addAll(STATIC_ASSETS)).then(()=>self.skipWaiting()));
    });
    self.addEventListener('activate', e=>{
      e.waitUntil(
        caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==STATIC_CACHE).map(k=>caches.delete(k))))
      );
    });
    // tiles: runtime cacheï¼ˆå¯é›¢ç·šé‡çœ‹å·²ç¶“èµ°éçš„åœ–å¡Šï¼‰
    self.addEventListener('fetch', e=>{
      const req = e.request; const url = new URL(req.url);
      if (url.hostname.endsWith('cartocdn.com') || url.hostname.endsWith('openstreetmap.org')) {
        e.respondWith(caches.open('tiles-v3').then(async cache=>{
          const cached = await cache.match(req);
          if (cached) return cached;
          try { const fresh = await fetch(req, {mode:'cors'}); cache.put(req, fresh.clone()); return fresh; }
          catch (err) { return cached || Response.error(); }
        }));
        return;
      }
      e.respondWith(caches.match(req).then(cached=>cached || fetch(req)));
    });
  `;
                const swBlob = new Blob([swCode], { type: "text/javascript" });
                const swUrl = URL.createObjectURL(swBlob);
                if ("serviceWorker" in navigator)
                    navigator.serviceWorker.register(swUrl);
            })();

            /* ====== 50 åº§æ¸…å–®ï¼ˆç§»é™¤æœ¨æ•™å ‚ï¼›åŠ å…¥ Agnes ä¿®é“é™¢ï¼‰ ======
   âœ… ä¸¦æ–°å¢ã€Œè–æ–¹æ¿Ÿå„æ•™å ‚ï¼ˆç´…æ˜Ÿåå­—é¨å£«åœ˜ï¼‰ã€ä½œç‚ºç¬¬ 49 é»ä¾†æºï¼Œç¢ºä¿ç¸½æ•¸ 50ã€‚ */
            const PLACES = [
                // Castle area
                {
                    en: "St. Vitus Cathedral",
                    zh: "è–ç¶­ç‰¹ä¸»æ•™åº§å ‚",
                    desc: "æ·å…‹æœ€é‡è¦çš„å“¥å¾·å¼æ•™å ‚ï¼Œæ­·ä»£åœ‹ç‹åŠ å†•èˆ‡å®‰è‘¬ä¹‹åœ°ã€‚",
                    lat: 50.0909,
                    lon: 14.4006,
                },
                {
                    en: "St. George's Basilica",
                    zh: "è–å–¬æ²»è–æ®¿",
                    desc: "å®Œæ•´ç¾…é¦¬å¼ä»£è¡¨ï¼Œå…§æœ‰è–å¥³éœ²å¾·ç±³æ‹‰å¢“ã€‚",
                    lat: 50.0905,
                    lon: 14.402,
                },
                {
                    en: "All Saints Church (KapitulnÃ­ kostel VÅ¡ech svatÃ½ch)",
                    zh: "è«¸è–å ‚",
                    desc: "åŸå ¡æ—çš‡å®¤ç¦®æ‹œç©ºé–“ã€‚",
                    lat: 50.0902,
                    lon: 14.404,
                },
                {
                    en: "Church of St. Benedict",
                    zh: "è–æœ¬ç¯¤æ•™å ‚",
                    desc: "17ä¸–ç´€å·´æ´›å…‹å°å ‚ã€‚",
                    lat: 50.0912,
                    lon: 14.4058,
                },
                {
                    en: "Loreta",
                    zh: "æ´›é›·å¡”",
                    desc: "å·´æ´›å…‹æœè–åœ°ï¼Œè–å±‹èˆ‡å ±æ™‚éŠ€é˜ã€‚",
                    lat: 50.0885,
                    lon: 14.3893,
                },
                {
                    en: "Strahov Monastery â€“ Basilica of the Assumption",
                    zh: "æ–¯ç‰¹æ‹‰éœå¤«ä¿®é“é™¢è–æ¯å‡å¤©å¤§æ®¿",
                    desc: "12ä¸–ç´€ä¿®é“é™¢ï¼Œåœ–æ›¸é¤¨èˆ‡è—è¡“è—å“è±å¯Œã€‚",
                    lat: 50.0863,
                    lon: 14.3913,
                },
                {
                    en: "St. Nicholas (MalÃ¡ Strana)",
                    zh: "å°åŸå€è–å°¼å¤æ‹‰",
                    desc: "å·´æ´›å…‹åœ“é ‚èˆ‡å£¯éº—ç®¡é¢¨ç´ã€‚",
                    lat: 50.088,
                    lon: 14.4043,
                },
                {
                    en: "Our Lady Victorious & Infant Jesus of Prague",
                    zh: "å‹åˆ©è–æ¯èˆ‡å¸ƒæ‹‰æ ¼è–å¬°",
                    desc: "åœ‹éš›æœè–åœ°ã€‚",
                    lat: 50.0851,
                    lon: 14.4047,
                },
                {
                    en: "St. Thomas Church (Augustinian)",
                    zh: "è–å¤šç‘ªæ•™å ‚ï¼ˆå¥§å¤æ–¯ä¸æœƒï¼‰",
                    desc: "ä¿®æœƒæ•™å ‚ï¼Œè—è¡“è£é£¾è¯éº—ã€‚",
                    lat: 50.087,
                    lon: 14.4048,
                },
                {
                    en: "Our Lady beneath the Chain",
                    zh: "éˆä¸‹è–æ¯æ•™å ‚",
                    desc: "é¦¬è€³ä»–é¨å£«åœ˜å¤æ•™å ‚ã€‚",
                    lat: 50.0868,
                    lon: 14.4059,
                },
                {
                    en: "St. Mary Magdalene (Orthodox)",
                    zh: "è–ç‘ªåˆ©äºç‘ªé”è‚‹ç´ï¼ˆæ±æ­£æ•™ï¼‰",
                    desc: "æ±æ­£æ•™æœ¨æ´‹è”¥å¡”é¢¨æ ¼ã€‚",
                    lat: 50.0876,
                    lon: 14.4095,
                },

                // Old Town core
                {
                    en: "Old Town St. Nicholas (Hussite)",
                    zh: "èˆŠåŸè–å°¼å¤æ‹‰ï¼ˆèƒ¡æ–¯æ´¾ï¼‰",
                    desc: "èˆŠåŸå»£å ´åŒ—å´åœ°æ¨™ã€‚",
                    lat: 50.0877,
                    lon: 14.4206,
                },
                {
                    en: "Church of Our Lady before TÃ½n",
                    zh: "æ³°æ©è–æ¯æ•™å ‚",
                    desc: "é›™å¡”å“¥å¾·åœ°æ¨™ã€‚",
                    lat: 50.0872,
                    lon: 14.4213,
                },
                {
                    en: "Basilica of St. James the Greater",
                    zh: "å¤§è–é›…å„ä¼¯è–æ®¿",
                    desc: "å·´æ´›å…‹å…§é£¾èˆ‡ã€æ–·æ‰‹å‚³èªªã€ã€‚",
                    lat: 50.0879,
                    lon: 14.4275,
                },
                {
                    en: "Church of St. Havel / St. Gall",
                    zh: "è–åŠ ä¾–æ•™å ‚",
                    desc: "ä¸­ä¸–ç´€åŸå¸‚æ•™å ‚ã€‚",
                    lat: 50.0846,
                    lon: 14.4222,
                },
                {
                    en: "Church of St. Giles",
                    zh: "è–å‰æ‹‰æ–¯æ•™å ‚",
                    desc: "å“¥å¾·Ã—å·´æ´›å…‹èåˆï¼›ç®¡é¢¨ç´è‘—åã€‚",
                    lat: 50.0859,
                    lon: 14.4209,
                },
                {
                    en: "Kostel sv. Martina ve zdi",
                    zh: "ç‰†ä¸­è–é¦¬ä¸",
                    desc: "æ—©æœŸå“¥å¾·å°å ‚ã€‚",
                    lat: 50.0848,
                    lon: 14.4219,
                },
                {
                    en: "Kostel U SalvÃ¡tora (Reformed)",
                    zh: "æ•‘ä¸»æ–°æ•™æ•™å ‚",
                    desc: "æ”¹é©å®—é‡é®ã€‚",
                    lat: 50.0887,
                    lon: 14.4264,
                },
                {
                    en: "Church of the Holy Spirit",
                    zh: "è–ç¥æ•™å ‚",
                    desc: "å‰å¤šæ˜æˆ‘å¥³ä¿®é™¢éºå€ã€‚",
                    lat: 50.0895,
                    lon: 14.4207,
                },
                {
                    en: "Armenian Apostolic Church",
                    zh: "äºç¾å°¼äºå®—å¾’æ•™æœƒ",
                    desc: "æ—ç¾¤èˆ‡ä¿¡ä»°å¤šå…ƒã€‚",
                    lat: 50.0917,
                    lon: 14.4271,
                },
                {
                    en: "Bethlehem Chapel",
                    zh: "ä¼¯åˆ©æ†ç¦®æ‹œå ‚",
                    desc: "èƒ¡æ–¯è¬›é“åœ°ï¼Œå®—æ”¹è±¡å¾µã€‚",
                    lat: 50.0846,
                    lon: 14.4179,
                },
                {
                    en: "St. Salvator (Klementinum, Jesuit)",
                    zh: "å…‹èŠé–€ç‰¹å­¸é™¢è–æ•‘ä¸–ä¸»",
                    desc: "è€¶ç©Œæœƒä¸»æ•™å ‚ã€‚",
                    lat: 50.0865,
                    lon: 14.4148,
                },
                {
                    en: "Church of St. Francis of Assisi (Knights of the Cross)",
                    zh: "è–æ–¹æ¿Ÿå„æ•™å ‚ï¼ˆç´…æ˜Ÿåå­—é¨å£«åœ˜ï¼‰",
                    desc: "æŸ¥ç†å¤§æ©‹èˆŠåŸç«¯çš„åœ“é ‚æ•™å ‚ã€‚",
                    lat: 50.0869,
                    lon: 14.4119,
                },
                {
                    en: "St. Clement (Byzantine Rite Cathedral)",
                    zh: "è–å…‹èŠå­Ÿï¼ˆæ±å„€ä¸»æ•™åº§ï¼‰",
                    desc: "çƒå…‹è˜­æ±å„€ä¸»æ•™åº§å ‚ã€‚",
                    lat: 50.086,
                    lon: 14.4156,
                },

                // New Town
                {
                    en: "Church of Our Lady of the Snows",
                    zh: "é›ªä¹‹è–æ¯æ•™å ‚",
                    desc: "åŸè¨ˆç•«å…¨åŸæœ€å¤§ã€‚",
                    lat: 50.0812,
                    lon: 14.4243,
                },
                {
                    en: "St. Ignatius of Loyola",
                    zh: "ä¾ç´çˆµç¾…è€€æ‹‰æ•™å ‚",
                    desc: "è€¶ç©Œæœƒåœ°æ¨™ï¼Œé€è¦–å¤©é ‚ç•«ã€‚",
                    lat: 50.0756,
                    lon: 14.4219,
                },
                {
                    en: "Church of St. Stephen (sv. Å tÄ›pÃ¡n)",
                    zh: "è–æ–¯å¾·æœ›æ•™å ‚",
                    desc: "14ä¸–ç´€æ–°åŸæ—©æœŸï¼Œå¡”æ™¯ä½³ã€‚",
                    lat: 50.0755,
                    lon: 14.4292,
                },
                {
                    en: "Church of St. Henry & St. Cunigunde",
                    zh: "è–äº¨åˆ©èˆ‡è–æ˜†å°¼è²¢å¾·",
                    desc: "å“¥å¾·å¡”èˆ‡çš‡æ¬Šè±¡å¾µã€‚",
                    lat: 50.0824,
                    lon: 14.4317,
                },
                {
                    en: "Holy Cross Church",
                    zh: "è–åå­—æ•™å ‚",
                    desc: "é†«é™¢æ•™å ‚ï¼Œå£ç•«ä½³ã€‚",
                    lat: 50.084,
                    lon: 14.4278,
                },
                {
                    en: "Church of St. Joseph (Capuchin)",
                    zh: "è–è‹¥ç‘Ÿï¼ˆå˜‰å¸ƒé£æœƒï¼‰",
                    desc: "ä¿®æœƒç°¡æ¨¸ä¹‹ç¾ã€‚",
                    lat: 50.0846,
                    lon: 14.4297,
                },
                {
                    en: "Jan Hus Chapel",
                    zh: "æšèƒ¡æ–¯ç¦®æ‹œå ‚",
                    desc: "ç¾ä»£ç´€å¿µå»ºç¯‰ã€‚",
                    lat: 50.0817,
                    lon: 14.423,
                },
                {
                    en: "Church of St. Apollinaire",
                    zh: "è–é˜¿ç»é‡Œç´æ•™å ‚",
                    desc: "14ä¸–ç´€å“¥å¾·ï¼Œå…§æœ‰å£ç•«ã€‚",
                    lat: 50.0712,
                    lon: 14.4325,
                },
                {
                    en: "Church of St. Katherine of Alexandria",
                    zh: "è–å‡±ç‘Ÿç³æ•™å ‚",
                    desc: "ç²‰è‰²å¤–ç‰†èˆ‡å„ªé›…å…§é£¾ã€‚",
                    lat: 50.0705,
                    lon: 14.4291,
                },
                {
                    en: "St. VorÅ¡ily (Ursulines)",
                    zh: "è–çƒçˆ¾è˜‡æ‹‰æ•™å ‚",
                    desc: "å¥³å­æ•™è‚²ä¿®æœƒæ“šé»ã€‚",
                    lat: 50.0774,
                    lon: 14.4175,
                },
                {
                    en: "Kostel sv. VÃ¡clava na Zderaze",
                    zh: "èŒ²å¾·æ‹‰æ¾¤çš„è–æº«å¡æ–¯æ‹‰æ–¯",
                    desc: "èƒ¡æ–¯æ´¾é‡è¦éºè·¡ã€‚",
                    lat: 50.0765,
                    lon: 14.4187,
                },
                {
                    en: "Ss. Cyril and Methodius Cathedral (New Town)",
                    zh: "è–è¥¿é‡Œçˆ¾èˆ‡æ¢…æ‰˜ç‹„çƒæ–¯ä¸»æ•™åº§å ‚",
                    desc: "äºŒæˆ°æŠµæŠ—è–åœ°ã€‚",
                    lat: 50.0737,
                    lon: 14.4185,
                },

                // VyÅ¡ehrad
                {
                    en: "Basilica of Sts. Peter & Paul (VyÅ¡ehrad)",
                    zh: "ç¶­è¬èµ«æ‹‰å¾·è–ä¼¯å¤šç¥¿èˆ‡ä¿ç¥¿å¤§æ®¿",
                    desc: "é›™å¡”åœ°æ¨™ï¼Œé„°åœ‹å®¶å…¬å¢“ã€‚",
                    lat: 50.0653,
                    lon: 14.4198,
                },
                {
                    en: "Rotunda sv. Martina (VyÅ¡ehrad)",
                    zh: "è–é¦¬ä¸åœ“å½¢å ‚ï¼ˆç¶­è¬èµ«æ‹‰å¾·ï¼‰",
                    desc: "11ä¸–ç´€çŸ³ç Œåœ“å ‚ã€‚",
                    lat: 50.0645,
                    lon: 14.4179,
                },
                {
                    en: "Church of the Holy Trinity (VyÅ¡ehrad area)",
                    zh: "è–ä¸‰æ•™å ‚ï¼ˆç¶­è¬èµ«æ‹‰å¾·å€ï¼‰",
                    desc: "é«˜åœ°å°å‹éœä¿®é»ã€‚",
                    lat: 50.0641,
                    lon: 14.4206,
                },

                // KarlÃ­n / Å½iÅ¾kov / Vinohrady
                {
                    en: "Ss. Cyril and Methodius (KarlÃ­n)",
                    zh: "è–è¥¿é‡Œçˆ¾èˆ‡æ¢…æ‰˜ç‹„çƒæ–¯ï¼ˆå¡æ—ï¼‰",
                    desc: "19ä¸–ç´€æ–°ç¾…é¦¬å¼å·¨æ§‹ã€‚",
                    lat: 50.0918,
                    lon: 14.4488,
                },
                {
                    en: "Basilica of St. Ludmila (Vinohrady)",
                    zh: "è–éœ²å¾·ç±³æ‹‰å¤§æ®¿ï¼ˆç¶­è«¾èµ«æ‹‰è¿ªï¼‰",
                    desc: "æ–°å“¥å¾·é›™å¡”ã€‚",
                    lat: 50.0755,
                    lon: 14.4399,
                },
                {
                    en: "Sacred Heart (Kostel NejsvÄ›tÄ›jÅ¡Ã­ho Srdce PÃ¡nÄ›)",
                    zh: "è€¶ç©Œè–å¿ƒæ•™å ‚ï¼ˆç¶­è«¾èµ«æ‹‰è¿ªï¼‰",
                    desc: "PleÄnik å‚‘ä½œã€‚",
                    lat: 50.0793,
                    lon: 14.4506,
                },
                {
                    en: "Church of St. Procopius (Å½iÅ¾kov)",
                    zh: "è–æ™®ç¾…ç§‘æ¯”æ•™å ‚ï¼ˆæ—¥æ—¥ç§‘å¤«ï¼‰",
                    desc: "æ–°å“¥å¾·ï¼Œå·¥äººå€è±¡å¾µã€‚",
                    lat: 50.0834,
                    lon: 14.453,
                },
                {
                    en: "Church of St. Peter at PoÅ™Ã­ÄÃ­",
                    zh: "æ™®ç†±å¥‡çš„è–ä¼¯å¤šç¥¿æ•™å ‚",
                    desc: "ç¾…é¦¬å¼æ ¸å¿ƒå¤å ‚ã€‚",
                    lat: 50.0915,
                    lon: 14.4366,
                },

                // Medieval small / Others
                {
                    en: "Rotunda of the Holy Cross (MenÅ¡Ã­)",
                    zh: "å°è–åå­—åœ“å½¢å ‚",
                    desc: "12ä¸–ç´€åƒ…å­˜åœ“å ‚ã€‚",
                    lat: 50.0876,
                    lon: 14.4228,
                },
                {
                    en: "Rotunda of St. Longinus",
                    zh: "è–éš†åŸºåŠªæ–¯åœ“å½¢å ‚",
                    desc: "æ—©æœŸåœ“å ‚ï¼Œæ¯”ä¾‹ç´”ç²¹ã€‚",
                    lat: 50.0736,
                    lon: 14.4272,
                },
                {
                    en: "Emmaus Monastery â€“ Our Lady & St. Charles the Great",
                    zh: "è‰¾ç‘ªçƒæ–¯ä¿®é“é™¢",
                    desc: "æ–¯æ‹‰å¤«ç¦®å‚³çµ±ï¼Œç¾ä»£å±‹é ‚ã€‚",
                    lat: 50.0739,
                    lon: 14.4156,
                },
                {
                    en: "St. John of Nepomuk na Skalce",
                    zh: "å²©ä¸Šè–è‹¥æœ›Â·ç´æ³¢ç©†å…‹",
                    desc: "æ®‰é“ä¸»é¡Œå·´æ´›å…‹ã€‚",
                    lat: 50.0751,
                    lon: 14.4144,
                },
                {
                    en: "St. Clement's (Klementinum complex)",
                    zh: "å…‹èŠé–€ç‰¹å­¸é™¢è–å…‹èŠå­Ÿ",
                    desc: "è€¶ç©Œæœƒå­¸é™¢ç¾¤ä¸€éƒ¨åˆ†ã€‚",
                    lat: 50.0861,
                    lon: 14.4152,
                },

                // Agnes Monasteryï¼ˆç¬¬ 50ï¼‰
                {
                    en: "St. Agnes Monastery â€“ Church of St. Francis & St. Salvator",
                    zh: "è–è‰¾æ ¼å°¼çµ²ä¿®é“é™¢ï¼ˆæ–¹æ¿Ÿèˆ‡æ•‘ä¸–ä¸»ï¼‰",
                    desc: "ä¸­ä¸–ç´€å¥³ä¿®é™¢éºå€ï¼Œåœ‹å®¶ç¾è¡“é¤¨åˆ†é¤¨ã€‚",
                    lat: 50.0925,
                    lon: 14.4292,
                },
            ];

            // é¡¯ç¤ºç­†æ•¸ï¼ˆå¿…é ˆ 50ï¼‰
            const countInfo = document.getElementById("countInfo");
            countInfo.textContent = `Loaded places: ${PLACES.length} / 50`;
            if (PLACES.length !== 50)
                alert(`ç›®å‰è¼‰å…¥ ${PLACES.length} ç­†ï¼Œæ‡‰ç‚º 50ã€‚è«‹æª¢æŸ¥æ¸…å–®ã€‚`);

            /* ====== è·é›¢ & è¿‘ä¼¼æœ€çŸ­è·¯å¾‘ï¼ˆNN + 2-optï¼‰ ====== */
            const toRad = (d) => (d * Math.PI) / 180;
            function haversine(lat1, lon1, lat2, lon2) {
                const R = 6371000;
                const dphi = toRad(lat2 - lat1),
                    dlmb = toRad(lon2 - lon1);
                const a =
                    Math.sin(dphi / 2) ** 2 +
                    Math.cos(toRad(lat1)) *
                        Math.cos(toRad(lat2)) *
                        Math.sin(dlmb / 2) ** 2;
                return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            }
            function nearestNeighbor(points, startIdx = 0) {
                const unvisited = new Set(points.map((_, i) => i));
                const route = [startIdx];
                unvisited.delete(startIdx);
                while (unvisited.size) {
                    const last = route[route.length - 1];
                    let best = null,
                        bestD = Infinity;
                    for (const j of unvisited) {
                        const d = haversine(
                            points[last].lat,
                            points[last].lon,
                            points[j].lat,
                            points[j].lon,
                        );
                        if (d < bestD) {
                            bestD = d;
                            best = j;
                        }
                    }
                    route.push(best);
                    unvisited.delete(best);
                }
                return route;
            }
            function twoOpt(route, pts, maxIter = 220) {
                function seg(a, b) {
                    return haversine(
                        pts[a].lat,
                        pts[a].lon,
                        pts[b].lat,
                        pts[b].lon,
                    );
                }
                let improved = true,
                    iter = 0;
                while (improved && iter < maxIter) {
                    improved = false;
                    iter++;
                    for (let i = 0; i < route.length - 2; i++) {
                        for (let j = i + 2; j < route.length - 1; j++) {
                            const A = route[i],
                                B = route[i + 1],
                                C = route[j],
                                D = route[j + 1];
                            const curr = seg(A, B) + seg(C, D);
                            const swap = seg(A, C) + seg(B, D);
                            if (swap + 1e-7 < curr) {
                                const slice = route
                                    .slice(i + 1, j + 1)
                                    .reverse();
                                route.splice(i + 1, j - i, ...slice);
                                improved = true;
                            }
                        }
                    }
                }
                return route;
            }
            function totalDistance(route, pts) {
                let s = 0;
                for (let i = 0; i < route.length - 1; i++) {
                    const A = pts[route[i]],
                        B = pts[route[i + 1]];
                    s += haversine(A.lat, A.lon, B.lat, B.lon);
                }
                return s;
            }

            // èµ·é»ï¼šæ³°æ©è–æ¯ï¼ˆæ‰¾ä¸åˆ°å°± 0ï¼‰
            const startIndex = PLACES.findIndex((p) =>
                /Our Lady before TÃ½n/i.test(p.en),
            );
            const nn = nearestNeighbor(
                PLACES,
                startIndex >= 0 ? startIndex : 0,
            );
            const order = twoOpt(nn.slice(), PLACES);

            /* ====== Leafletï¼šCarto Positron æ¥µç°¡åº•åœ– ====== */
            const map = L.map("map", { zoomControl: true });
            L.tileLayer(
                "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
                {
                    maxZoom: 19,
                    attribution: "&copy; OpenStreetMap &copy; CARTO",
                },
            ).addTo(map);

            function numberedIcon(n) {
                return L.divIcon({
                    className: "num-marker",
                    html: String(n).padStart(2, "0"),
                    iconSize: [28, 28],
                    iconAnchor: [14, 14],
                });
            }

            /* ====== Google Maps é€£çµï¼ˆåç¨±æœå°‹å„ªå…ˆ + åº§æ¨™å‚™æ´ï¼‰ & ç­†è¨˜ ====== */
            function gmapsByName(p) {
                const q = encodeURIComponent(`${p.en}, Prague, Czechia`);
                return `https://www.google.com/maps/search/?api=1&query=${q}`;
            }
            function gmapsByCoord(p) {
                return `https://www.google.com/maps?q=${p.lat},${p.lon}`;
            }
            function noteKey(p) {
                return `pp_note_${p.lat.toFixed(6)}_${p.lon.toFixed(6)}`;
            }
            function getNote(p) {
                return localStorage.getItem(noteKey(p)) || "";
            }

            // ç¹ªè£½é»èˆ‡è·¯å¾‘
            const latlngs = [];
            const list = document.getElementById("list");
            const markersData = []; // å„²å­˜æ¨™è¨˜è³‡è¨Šä»¥ä¾¿ç¨å¾Œæ›´æ–°

            order.forEach((idx, i) => {
                const p = PLACES[idx];
                latlngs.push([p.lat, p.lon]);
                const title = `${String(i + 1).padStart(2, "0")}. ${p.en}ï¼ˆ${p.zh}ï¼‰`;
                const id = noteKey(p);
                const seqNum = i + 1;

                markersData.push({ p, id, seqNum, title });

                // å‰µå»ºå‡½æ•¸ä¾†ç”Ÿæˆ popup å…§å®¹ï¼Œæ¯æ¬¡æ‰“é–‹æ™‚éƒ½æœƒé‡æ–°è®€å– localStorage
                function getPopupContent() {
                    const currentNote = getNote(p);
                    return `
    <h3>${title}</h3>
    <p>${p.desc}</p>
    <div class="popup-actions">
      <a class="primary" href="${gmapsByName(p)}" target="_blank" rel="noopener">ç”¨åç¨±é–‹å•Ÿ Google Maps</a>
      <a href="${gmapsByCoord(p)}" target="_blank" rel="noopener">ç”¨åº§æ¨™é–‹å•Ÿ</a>
      <button onclick="showFullscreenNumber(${seqNum})">ğŸ”¢ é¡¯ç¤ºè™Ÿç¢¼</button>
    </div>
    <div style="margin-top:8px;">
      <textarea class="note-box" id="${id}" placeholder="åœ¨æ­¤è¼¸å…¥ç­†è¨˜ï¼ˆåƒ…å„²å­˜åœ¨æœ¬æ©Ÿï¼‰">${currentNote}</textarea>
      <div class="popup-actions" style="margin-top:6px;">
        <button class="primary" onclick="saveNote('${id}')">ğŸ’¾ å„²å­˜ç­†è¨˜</button>
      </div>
    </div>`;
                }

                const m = L.marker([p.lat, p.lon], {
                    icon: numberedIcon(seqNum),
                    title,
                });

                // ä½¿ç”¨ Leaflet çš„ popup äº‹ä»¶ï¼Œåœ¨æ¯æ¬¡æ‰“é–‹æ™‚æ›´æ–°å…§å®¹
                const popup = L.popup({ maxWidth: 320 });
                m.bindPopup(popup);

                m.on("click", function () {
                    popup.setContent(getPopupContent());
                });

                m.addTo(map);

                // æ¸…å–®åˆ—å‡ºï¼ˆå¯é»ï¼‰
                const li = document.createElement("li");
                li.innerHTML = `<a href="#" onclick="return false;">${title}</a>`;
                li.addEventListener("click", () => {
                    popup.setContent(getPopupContent());
                    m.openPopup();
                    map.panTo([p.lat, p.lon]);
                });
                list.appendChild(li);
            });

            // è·¯å¾‘ & è¦–çª—
            const poly = L.polyline(latlngs, {
                color: "#0A84FF",
                weight: 4,
                opacity: 0.85,
            }).addTo(map);
            map.fitBounds(poly.getBounds(), { padding: [28, 28] });

            // ç¸½è·é›¢
            const distKm = (totalDistance(order, PLACES) / 1000).toFixed(1);
            document.getElementById("dist").textContent =
                `Total route â‰ˆ ${distKm} km | Points: ${order.length}`;

            // æ¸…å–®æŠ½å±œ toggle
            const drawer = document.getElementById("drawer");
            document.getElementById("listBtn").addEventListener("click", () => {
                drawer.style.display =
                    drawer.style.display === "block" ? "none" : "block";
            });

            /* ====== CSV ä¸‹è¼‰ï¼š50 åº§ï¼‹ç­†è¨˜ ====== */
            function downloadCSV() {
                const header = [
                    "Index",
                    "English",
                    "Chinese",
                    "Description",
                    "Lat",
                    "Lon",
                    "Note",
                ];
                const rows = order.map((idx, i) => {
                    const p = PLACES[idx];
                    const note = (getNote(p) || "").replace(/\r?\n/g, " ");
                    return [i + 1, p.en, p.zh, p.desc, p.lat, p.lon, note];
                });
                const csv = [header, ...rows]
                    .map((r) =>
                        r
                            .map((v) => {
                                const s = String(v ?? "");
                                return /[",\n]/.test(s)
                                    ? `"${s.replace(/"/g, '""')}"`
                                    : s;
                            })
                            .join(","),
                    )
                    .join("\n");
                const blob = new Blob([csv], {
                    type: "text/csv;charset=utf-8;",
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "Prague_Pilgrim_Notes.csv";
                a.click();
                URL.revokeObjectURL(url);
            }
            document
                .getElementById("downloadCsvBtn")
                .addEventListener("click", downloadCSV);

            /* ====== ä½¿ç”¨è€…å®šä½ ====== */
            let userMarker, userCircle;
            document
                .getElementById("locateBtn")
                .addEventListener("click", () => {
                    // è«‹æ±‚å®šä½æ¬Šé™ä¸¦è¨­å®šè¦–åœ–
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const lat = position.coords.latitude;
                                const lon = position.coords.longitude;
                                const accuracy = position.coords.accuracy;

                                if (userMarker) {
                                    map.removeLayer(userMarker);
                                    map.removeLayer(userCircle);
                                }

                                userMarker = L.marker([lat, lon], {
                                    title: "Your Location",
                                }).addTo(map);

                                userCircle = L.circle([lat, lon], {
                                    radius: accuracy,
                                    color: "#34c759",
                                }).addTo(map);

                                map.setView([lat, lon], 16);
                            },
                            (error) => {
                                let msg = "å®šä½å¤±æ•—";
                                if (error.code === 1)
                                    msg =
                                        "å®šä½å¤±æ•—ï¼šè«‹åœ¨ç€è¦½å™¨è¨­å®šä¸­å…è¨±ä½ç½®æ¬Šé™";
                                else if (error.code === 2)
                                    msg = "å®šä½å¤±æ•—ï¼šç„¡æ³•å–å¾—ä½ç½®è³‡è¨Š";
                                else if (error.code === 3)
                                    msg = "å®šä½å¤±æ•—ï¼šè«‹æ±‚é€¾æ™‚";
                                alert(msg);
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 0,
                            },
                        );
                    } else {
                        alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
                    }
                });

            // ä¿ç•™ Leaflet çš„å®šä½äº‹ä»¶è™•ç†ï¼ˆä½œç‚ºå‚™ç”¨ï¼‰
            map.on("locationfound", (e) => {
                if (userMarker) {
                    map.removeLayer(userMarker);
                    map.removeLayer(userCircle);
                }
                userMarker = L.marker(e.latlng, {
                    title: "Your Location",
                }).addTo(map);
                userCircle = L.circle(e.latlng, {
                    radius: e.accuracy,
                    color: "#34c759",
                }).addTo(map);
                if (!map.getBounds().contains(e.latlng)) map.panTo(e.latlng);
            });
            map.on("locationerror", (e) => alert("å®šä½å¤±æ•—ï¼š" + e.message));

            /* ====== å…¨åŸŸå‡½æ•¸ï¼šå„²å­˜ç­†è¨˜ & é¡¯ç¤ºå…¨å±è™Ÿç¢¼ ====== */
            window.saveNote = function (noteId) {
                const textarea = document.getElementById(noteId);
                if (textarea) {
                    const text = textarea.value;
                    localStorage.setItem(noteId, (text || "").trim());
                    alert("å·²å„²å­˜è‡³æœ¬æ©Ÿ");
                }
            };

            window.showFullscreenNumber = function (num) {
                const display = document.getElementById("fullscreenNumber");
                const numberEl = document.getElementById("bigNumber");
                numberEl.textContent = String(num).padStart(2, "0");
                display.classList.add("show");
            };
        </script>
    </body>
</html>
