<!doctype html>
<html lang="zh-Hant">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <link rel="manifest" href="manifest.webmanifest" />
        <meta name="theme-color" content="#0d6efd" />
        <title>聖經和合本</title>
        <style>
            :root {
                /* THEME (dark default) */
                --bg: #0b0e12;
                --fg: #e8e8e8;
                --muted: #9aa0a6;
                --acc: #0d6efd;
                --card: #151a20;
                --line: #24303a;
                --chip: #10161c;
                --chip-line: #2b3947;
                --mark-bg: #2b3f64;
                --fs: 1.8rem; /* base verse font size */
            }
            :root[data-theme="light"] {
                --bg: #ffffff;
                --fg: #111827;
                --muted: #6b7280;
                --acc: #0d6efd;
                --card: #f9fafb;
                --line: #e5e7eb;
                --chip: #ffffff;
                --chip-line: #e5e7eb;
                --mark-bg: #fde68a;
            }
            html,
            body {
                margin: 0;
                height: 100%;
                background: var(--bg);
                color: var(--fg);
                font-family:
                    system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    Helvetica,
                    Arial;
            }
            body {
                font-size: var(--fs);
            }

            header {
                position: sticky;
                top: 0;
                background: var(--card);
                padding: 0.6rem 0.9rem;
                border-bottom: 1px solid var(--line);
                z-index: 20;
                display: grid;
                grid-template-columns: auto 1fr auto;
                align-items: center;
                gap: 0.6rem;
            }
            .brand {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            .badge {
                display: inline-block;
                background: #152237;
                border: 1px solid #20314a;
                color: #aac4ff;
                font-size: 0.75rem;
                padding: 0.05rem 0.4rem;
                border-radius: 0.4rem;
            }
            .toolbar {
                display: flex;
                gap: 0.5rem;
                align-items: center;
                justify-self: center;
                flex-wrap: wrap;
            }
            .rightbar {
                justify-self: end;
                display: flex;
                gap: 0.4rem;
                align-items: center;
            }
            h1 {
                font-size: 1.05rem;
                margin: 0;
            }

            select,
            input[type="search"],
            input[type="range"],
            button.toggle {
                background: var(--chip);
                color: var(--fg);
                border: 1px solid var(--chip-line);
                border-radius: 0.5rem;
                padding: 0.35rem 0.55rem;
                font-size: 0.95rem;
            }
            input[type="range"] {
                padding: 0;
                height: 1.75rem;
            }
            .chapters {
                display: flex;
                flex-wrap: wrap;
                gap: 0.35rem;
                margin: 0.25rem 0;
            }
            .chapters button {
                background: var(--chip);
                border: 1px solid var(--chip-line);
                color: var(--fg);
                padding: 0.3rem 0.45rem;
                border-radius: 0.4rem;
                cursor: pointer;
                font-size: 0.95rem;
            }
            .chapters button.active {
                background: var(--acc);
                border-color: var(--acc);
                color: #fff;
            }
            .content {
                display: grid;
                grid-template-columns: 320px 1fr;
                gap: 1rem;
                padding: 1rem;
            }
            .sidebar {
                background: var(--card);
                border: 1px solid var(--line);
                border-radius: 0.5rem;
                padding: 0.75rem;
                overflow: auto;
                max-height: calc(100dvh - 92px);
            }
            .verses {
                background: var(--card);
                border: 1px solid var(--line);
                border-radius: 0.5rem;
                padding: 1rem;
                line-height: 1.8;
                max-width: 80ch;
            }
            .verse {
                margin: 0.12rem 0;
            }
            .vno {
                color: var(--muted);
                font-size: 0.9rem;
                margin-right: 0.35rem;
            }
            .muted {
                color: var(--muted);
            }
            mark {
                background: var(--mark-bg);
                color: inherit;
                padding: 0.05rem 0.15rem;
                border-radius: 0.2rem;
            }

            /* Drawer (slide-out options) */
            .menu-btn {
                border: 1px solid var(--chip-line);
                background: var(--chip);
                border-radius: 0.55rem;
                cursor: pointer;
            }
            .drawer-backdrop {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.35);
                backdrop-filter: saturate(120%) blur(2px);
                opacity: 0;
                pointer-events: none;
                transition: 0.2s opacity;
                z-index: 30;
            }
            .drawer {
                position: fixed;
                top: 0;
                bottom: 0;
                width: min(92vw, 360px);
                background: var(--card);
                border-right: 1px solid var(--line);
                transform: translateX(-100%);
                transition: 0.25s transform;
                z-index: 31;
                overflow: auto;
            }
            body.drawer-open .drawer {
                transform: translateX(0);
            }
            body.drawer-open .drawer-backdrop {
                opacity: 1;
                pointer-events: auto;
            }

            .drawer-header {
                position: sticky;
                top: 0;
                background: var(--card);
                padding: 0.8rem;
                border-bottom: 1px solid var(--line);
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            .drawer-title {
                font-weight: 700;
            }
            .group-title {
                padding: 0.75rem 0.9rem 0.25rem;
                font-weight: 700;
            }
            .sub-title {
                padding: 0.35rem 0.9rem;
                font-weight: 600;
                color: var(--muted);
                font-size: 0.95rem;
            }
            .book-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 0.5rem;
                padding: 0.35rem 0.75rem;
                cursor: pointer;
                border-top: 1px solid var(--line);
            }
            .book-left {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            .arrow {
                transition: 0.2s transform;
            }
            .book-item.open .arrow {
                transform: rotate(90deg);
            }
            .chap-list {
                display: none;
                padding: 0.45rem 0.9rem;
                gap: 0.35rem;
                flex-wrap: wrap;
            }
            .book-item.open + .chap-list {
                display: flex;
            }
            .drawer-footer {
                position: sticky;
                bottom: 0;
                background: var(--card);
                border-top: 1px solid var(--line);
                padding: 0.7rem 0.8rem;
                display: flex;
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            .pill {
                background: var(--chip);
                border: 1px solid var(--chip-line);
                border-radius: 0.6rem;
                padding: 0.35rem 0.6rem;
                cursor: pointer;
            }
            .about {
                display: none;
                margin: 1rem 0;
            }
            .about.active {
                display: block;
            }

            /* Mobile adjustments: options button on the right; hide left sidebar */
            body.mobile .content {
                grid-template-columns: 1fr;
            }
            body.mobile .sidebar {
                display: none;
            }
            body.mobile header {
                grid-template-columns: 1fr auto auto;
            }
            body.mobile .brand {
                order: 1;
            }
            body.mobile .toolbar {
                order: 2;
                justify-self: start;
            }
            body.mobile .rightbar {
                order: 3;
                justify-self: end;
            }

            /* Desktop: options button on the left (brand area) */
            .brand .menu-btn {
                display: inline-flex;
            }
            @media (max-width: 900px) {
                /* On narrow screens, hide chapter pile if too cramped — still available in drawer */
                .chapters {
                    display: none;
                }
            }
        </style>
    </head>
    <body>
        <header>
            <!-- Desktop: menu on left; Mobile: CSS places rightbar at end -->
            <div class="brand">
                <button id="menuBtnLeft" class="menu-btn" title="選單 ☰">
                    ☰
                </button>
                <h1>聖經和合本 <span class="badge">PWA</span></h1>
            </div>

            <div class="toolbar">
                <label class="muted">書卷：</label>
                <select id="bookSel"></select>
                <span id="chapterArea" class="chapters"></span>
                <input
                    id="q"
                    type="search"
                    placeholder="全文搜尋（離線）"
                    style="min-width: 16ch"
                />
            </div>

            <div class="rightbar">
                <button id="menuBtnRight" class="menu-btn" title="選單 ☰">
                    ☰
                </button>
            </div>
        </header>

        <!-- Drawer -->
        <div class="drawer-backdrop" id="backdrop"></div>
        <aside class="drawer" id="drawer">
            <div class="drawer-header">
                <strong class="drawer-title">選單</strong>
                <span class="muted" style="margin-left: auto"
                    >展開書卷可選章節</span
                >
            </div>
            <div id="drawerContent"><!-- built by JS --></div>
            <div class="drawer-footer">
                <button id="fsDec" class="pill" title="字體變小">A−</button>
                <button id="fsInc" class="pill" title="字體變大">A+</button>
                <button id="themeBtn" class="pill" title="切換主題">
                    🌞/🌚
                </button>
                <button id="aboutBtn" class="pill" title="關於">
                    後補教會
                </button>
            </div>

            <div id="about" class="about">
                <div class="verses" style="max-width: unset">
                    <h2>聖經和合本，1919年</h2>
                    <p>
                        《聖經和合本》（Chinese Union Version,
                        CUV）為華人新教最普及之譯本，全書於
                        <strong>1919 年</strong
                        >正式出版（官話和合譯本），其後歷經校訂與新版（如 2010
                        年完成之和合本修訂版 RCUV）。
                    </p>
                    <h2>板橋後埔教會</h2>
                    <p>台灣基督長老教會後埔教會（新北市板橋區）。</p>
                    <ul>
                        <li>
                            <strong>主日禮拜時間：</strong>台語 09:00、華語
                            10:50（以教會最新公告為準）。
                        </li>
                        <li>
                            <strong>地址：</strong>新北市板橋區重慶路 276 之 1
                            號 3 樓。
                        </li>
                        <li><strong>網站：</strong>hpch.org.tw</li>
                    </ul>
                    <p class="muted" style="font-size: 0.95rem">
                        （資料來源：教會官網之聚會時間頁與長老教會教會資料庫；CUV
                        出版年資料見百科/資料站。）
                    </p>
                </div>
            </div>
        </aside>

        <div class="content">
            <aside class="sidebar" id="sidebar">
                <!-- desktop sidebar (unchanged) -->
            </aside>
            <main>
                <div id="reader" class="verses"></div>
            </main>
        </div>

        <script>
            /* ---------- Canonical groups & order (66) ---------- */
            const BOOKS_META = [
                {
                    heading: "舊約",
                    groups: [
                        {
                            sub: "摩西五書",
                            books: [
                                "創世記",
                                "出埃及記",
                                "利未記",
                                "民數記",
                                "申命記",
                            ],
                        },
                        {
                            sub: "歷史書",
                            books: [
                                "約書亞記",
                                "士師記",
                                "路得記",
                                "撒母耳記上",
                                "撒母耳記下",
                                "列王紀上",
                                "列王紀下",
                                "歷代志上",
                                "歷代志下",
                                "以斯拉記",
                                "尼希米記",
                                "以斯帖記",
                            ],
                        },
                        {
                            sub: "詩歌智慧書",
                            books: ["約伯記", "詩篇", "箴言", "傳道書", "雅歌"],
                        },
                        {
                            sub: "大先知書",
                            books: [
                                "以賽亞書",
                                "耶利米書",
                                "耶利米哀歌",
                                "以西結書",
                                "但以理書",
                            ],
                        },
                        {
                            sub: "小先知書",
                            books: [
                                "何西阿書",
                                "約珥書",
                                "阿摩司書",
                                "俄巴底亞書",
                                "約拿書",
                                "彌迦書",
                                "那鴻書",
                                "哈巴谷書",
                                "西番雅書",
                                "哈該書",
                                "撒迦利亞書",
                                "瑪拉基書",
                            ],
                        },
                    ],
                },
                {
                    heading: "新約",
                    groups: [
                        {
                            sub: "福音書",
                            books: [
                                "馬太福音",
                                "馬可福音",
                                "路加福音",
                                "約翰福音",
                            ],
                        },
                        {
                            sub: "使徒行傳-by 路加：保羅的希臘好友",
                            books: ["使徒行傳"],
                        },
                        {
                            sub: "保羅書信",
                            books: [
                                "羅馬書",
                                "哥林多前書",
                                "哥林多後書",
                                "加拉太書",
                                "以弗所書",
                                "腓立比書",
                                "歌羅西書",
                                "帖撒羅尼迦前書",
                                "帖撒羅尼迦後書",
                                "提摩太前書",
                                "提摩太後書",
                                "提多書",
                                "腓利門書",
                                "希伯來書",
                            ],
                        },
                        { sub: "by雅各：耶穌的弟弟", books: ["雅各書"] },
                        {
                            sub: "by 彼得: 使徒",
                            books: ["彼得前書", "彼得後書"],
                        },
                        {
                            sub: "by 約翰：使徒",
                            books: ["約翰一書", "約翰二書", "約翰三書"],
                        },
                        { sub: " by猶大: 耶穌弟弟", books: ["猶大書"] },
                        { sub: " by 約翰：可能是使徒", books: ["啟示錄"] },
                    ],
                },
            ];

            const state = {
                data: null,
                orderedBooks: [],
                bookIdx: 0,
                chapIdx: 0,
                q: "",
                isMobile: false,
            };

            function detectMobile() {
                const ua = navigator.userAgent || "";
                const likelyMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(ua);
                const smallScreen =
                    Math.min(window.innerWidth, window.innerHeight) < 900;
                return likelyMobile || smallScreen;
            }

            async function loadData() {
                // Theme + font
                const theme = localStorage.getItem("theme") || "dark";
                document.documentElement.setAttribute("data-theme", theme);
                const fs = +(localStorage.getItem("fsPx") || 28);
                document.documentElement.style.setProperty("--fs", fs + "px");

                state.isMobile = detectMobile();
                document.body.classList.toggle("mobile", state.isMobile);

                const res = await fetch("bible.json", { cache: "no-cache" });
                state.data = await res.json();

                buildOrder();
                buildDesktopSidebar(); // visible on desktop only
                buildDropdown(); // top bar selector
                buildDrawer(); // slide-out menu (all devices)
                wireHeader();
                renderChapters();
                renderChapter();
            }

            function wireHeader() {
                // Menu buttons
                const left = document.getElementById("menuBtnLeft");
                const right = document.getElementById("menuBtnRight");
                const backdrop = document.getElementById("backdrop");
                const openDrawer = () =>
                    document.body.classList.add("drawer-open");
                const closeDrawer = () =>
                    document.body.classList.remove("drawer-open");
                left.addEventListener("click", openDrawer);
                right.addEventListener("click", openDrawer);
                backdrop.addEventListener("click", closeDrawer);
                window.addEventListener("keydown", (e) => {
                    if (e.key === "Escape") closeDrawer();
                });

                // Search
                document.getElementById("q").addEventListener("input", (e) => {
                    state.q = e.target.value.trim();
                    if (state.q) renderSearch(state.q);
                    else renderChapter();
                });

                // Book dropdown
                document
                    .getElementById("bookSel")
                    .addEventListener("change", (e) => {
                        state.bookIdx = +e.target.value;
                        state.chapIdx = 0;
                        renderChapters();
                        renderChapter();
                        highlightActiveInDesktopSidebar();
                    });
            }

            function presentBooksSet() {
                return new Set(state.data.books.map((b) => b.name));
            }

            function buildOrder() {
                const present = presentBooksSet();
                state.orderedBooks = [];
                BOOKS_META.forEach((sec) => {
                    sec.groups.forEach((gr) => {
                        gr.books.forEach((name) => {
                            if (present.has(name))
                                state.orderedBooks.push(name);
                        });
                    });
                });
            }

            function bookByOrderedIndex(i) {
                const name = state.orderedBooks[i];
                return state.data.books.find((b) => b.name === name);
            }

            function idxOfBook(name) {
                return state.orderedBooks.findIndex((n) => n === name);
            }

            function buildDropdown() {
                const sel = document.getElementById("bookSel");
                sel.innerHTML = "";
                state.orderedBooks.forEach((name, i) => {
                    const opt = document.createElement("option");
                    opt.value = i;
                    opt.textContent = name;
                    sel.appendChild(opt);
                });
                sel.value = String(state.bookIdx);
            }

            function buildDesktopSidebar() {
                const sidebar = document.getElementById("sidebar");
                if (!sidebar) return;
                const present = presentBooksSet();
                sidebar.innerHTML = "";
                BOOKS_META.forEach((section) => {
                    const h = document.createElement("div");
                    h.className = "group-title";
                    h.textContent = section.heading;
                    sidebar.appendChild(h);
                    section.groups.forEach((gr) => {
                        const sub = document.createElement("div");
                        sub.className = "sub-title";
                        sub.textContent = gr.sub;
                        sidebar.appendChild(sub);
                        const list = document.createElement("div");
                        list.className = "book-list";
                        gr.books.forEach((name) => {
                            if (!present.has(name)) return;
                            const row = document.createElement("div");
                            row.className = "book";
                            const btn = document.createElement("button");
                            btn.textContent = name;
                            btn.onclick = () => {
                                state.bookIdx = idxOfBook(name);
                                state.chapIdx = 0;
                                buildDropdown();
                                renderChapters();
                                renderChapter();
                                highlightActiveInDesktopSidebar();
                            };
                            row.appendChild(btn);
                            list.appendChild(row);
                        });
                        sidebar.appendChild(list);
                    });
                });
                highlightActiveInDesktopSidebar();
            }

            function highlightActiveInDesktopSidebar() {
                const sidebar = document.getElementById("sidebar");
                if (!sidebar) return;
                sidebar
                    .querySelectorAll(".book button")
                    .forEach((b) => b.classList.remove("active"));
                const activeName = state.orderedBooks[state.bookIdx];
                const btns = [
                    ...sidebar.querySelectorAll(".book button"),
                ].filter((b) => b.textContent === activeName);
                if (btns[0]) btns[0].classList.add("active");
            }

            function renderChapters() {
                const area = document.getElementById("chapterArea");
                area.innerHTML = "";
                const book = bookByOrderedIndex(state.bookIdx);
                if (!book) {
                    area.textContent = "本書卷不存在";
                    return;
                }
                book.chapters.forEach((ch, i) => {
                    const btn = document.createElement("button");
                    btn.textContent = ch.c;
                    btn.className = i === state.chapIdx ? "active" : "";
                    btn.onclick = () => {
                        state.chapIdx = i;
                        document.getElementById("q").value = "";
                        state.q = "";
                        renderChapters();
                        renderChapter();
                    };
                    area.appendChild(btn);
                });
            }

            function renderChapter() {
                const reader = document.getElementById("reader");
                const book = bookByOrderedIndex(state.bookIdx);
                const ch = book?.chapters?.[state.chapIdx];
                const info = document.getElementById("searchInfo");
                if (info) info.textContent = "";
                if (!ch) {
                    reader.innerHTML = '<div class="muted">本書沒有章節</div>';
                    return;
                }
                let html = `<div class="muted">${book.name} 第 ${ch.c} 章</div>`;
                ch.verses.forEach((v) => {
                    html += `<div class="verse"><span class="vno">${ch.c}:${v.v}</span>${escapeHtml(v.t)}</div>`;
                });
                reader.innerHTML = html;
            }

            function renderSearch(q) {
                const reader = document.getElementById("reader");
                const re = new RegExp(
                    q.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"),
                    "i",
                );
                let total = 0;
                let out = [];
                for (const name of state.orderedBooks) {
                    const book = state.data.books.find((b) => b.name === name);
                    if (!book) continue;
                    for (const ch of book.chapters) {
                        let printedHeader = false;
                        for (const v of ch.verses) {
                            if (re.test(v.t)) {
                                total++;
                                if (!printedHeader) {
                                    out.push(
                                        `<div class="muted" style="margin-top:.8rem">${book.name} 第 ${ch.c} 章</div>`,
                                    );
                                    printedHeader = true;
                                }
                                const txt = escapeHtml(v.t).replace(
                                    re,
                                    (m) => `<mark>${m}</mark>`,
                                );
                                out.push(
                                    `<div class="verse"><span class="vno">${ch.c}:${v.v}</span>${txt}</div>`,
                                );
                            }
                        }
                    }
                }
                reader.innerHTML = out.length
                    ? out.join("")
                    : '<div class="muted">沒有符合的結果</div>';
            }

            function escapeHtml(s) {
                return s
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
            }

            /* -------- Drawer builder (books with collapsible chapters) -------- */
            function buildDrawer() {
                const root = document.getElementById("drawerContent");
                root.innerHTML = "";
                const present = presentBooksSet();

                BOOKS_META.forEach((section) => {
                    const h = document.createElement("div");
                    h.className = "group-title";
                    h.textContent = section.heading;
                    root.appendChild(h);

                    section.groups.forEach((gr) => {
                        const sub = document.createElement("div");
                        sub.className = "sub-title";
                        sub.textContent = gr.sub;
                        root.appendChild(sub);

                        gr.books.forEach((name) => {
                            if (!present.has(name)) return;

                            const bookRow = document.createElement("div");
                            bookRow.className = "book-item";
                            const left = document.createElement("div");
                            left.className = "book-left";
                            const arrow = document.createElement("span");
                            arrow.className = "arrow";
                            arrow.textContent = "▶";
                            const label = document.createElement("span");
                            label.textContent = name;
                            left.append(arrow, label);

                            const goBtn = document.createElement("button");
                            goBtn.className = "pill";
                            goBtn.textContent = "前往";
                            goBtn.title = "前往第1章";

                            bookRow.append(left, goBtn);
                            root.appendChild(bookRow);

                            const chapList = document.createElement("div");
                            chapList.className = "chap-list";
                            const book = state.data.books.find(
                                (b) => b.name === name,
                            );
                            (book?.chapters || []).forEach((ch, i) => {
                                const cbtn = document.createElement("button");
                                cbtn.className = "pill";
                                cbtn.textContent = ch.c;
                                cbtn.onclick = () => {
                                    state.bookIdx = idxOfBook(name);
                                    state.chapIdx = i;
                                    buildDropdown();
                                    renderChapters();
                                    renderChapter();
                                    document.body.classList.remove(
                                        "drawer-open",
                                    );
                                };
                                chapList.appendChild(cbtn);
                            });
                            root.appendChild(chapList);

                            // Toggle chapters by clicking left part; clicking "前往" jumps to ch 1
                            left.addEventListener("click", () => {
                                bookRow.classList.toggle("open");
                            });
                            goBtn.addEventListener("click", () => {
                                state.bookIdx = idxOfBook(name);
                                state.chapIdx = 0;
                                buildDropdown();
                                renderChapters();
                                renderChapter();
                                document.body.classList.remove("drawer-open");
                            });
                        });
                    });
                });

                // Footer controls in drawer
                const fsDec = document.getElementById("fsDec");
                const fsInc = document.getElementById("fsInc");
                const themeBtn = document.getElementById("themeBtn");
                const aboutBtn = document.getElementById("aboutBtn");
                const about = document.getElementById("about");

                const setPx = (px) => {
                    document.documentElement.style.setProperty(
                        "--fs",
                        px + "px",
                    );
                    localStorage.setItem("fsPx", String(px));
                };
                const clamp = (v) => Math.max(14, Math.min(36, v));
                fsDec.addEventListener("click", () => {
                    const cur =
                        parseInt(
                            getComputedStyle(
                                document.documentElement,
                            ).getPropertyValue("--fs"),
                        ) || 28;
                    setPx(clamp(cur - 2));
                });
                fsInc.addEventListener("click", () => {
                    const cur =
                        parseInt(
                            getComputedStyle(
                                document.documentElement,
                            ).getPropertyValue("--fs"),
                        ) || 28;
                    setPx(clamp(cur + 2));
                });
                themeBtn.addEventListener("click", () => {
                    const cur =
                        document.documentElement.getAttribute("data-theme") ||
                        "dark";
                    const next = cur === "dark" ? "light" : "dark";
                    document.documentElement.setAttribute("data-theme", next);
                    localStorage.setItem("theme", next);
                });
                aboutBtn.addEventListener("click", () => {
                    about.classList.toggle("active");
                    // keep drawer open; content toggles in place
                });
            }

            // PWA SW
            if ("serviceWorker" in navigator) {
                window.addEventListener("load", () =>
                    navigator.serviceWorker.register("sw.js"),
                );
            }

            loadData();
        </script>
    </body>
</html>
